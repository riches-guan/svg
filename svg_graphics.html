<!--
  Copyright 2019, Bart Butenaers, Stephen McLaughlin
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<style>
    .ui-svg-ui-autocomplete {
        max-height: 100px;
        overflow-y: auto;
        overflow-x: hidden; /* prevent horizontal scrollbar */
        /*padding-right: 20px;/* add padding to account for vertical scrollbar */
    } 
    #svg-dialog-div {
        padding: 0px 0px 0px 0px;
    }
    .msgboxOuter {
        display: table; 
        width: 100px; 
        height:100px; 
        overflow: hidden;
    }
    .msgboxOuter .msgboxInner {
        display: table-cell;
        vertical-align: middle;
        width: 100%;
        margin: 0 auto;
        text-align: left;
    }
    .msgboxInnerLeft{
        padding: 20px 0px 10px 20px;
        float: left; 
    }
    .msgboxInnerRight{
        padding: 20px 10px 10px 20px;
        width: 300px; 
    }
    .svgButtonIcon {
        padding: 4px 0px 0px 0px;
        width: 40px;
        text-align: center;
        height: 40px;
    }
    .svgButtonText {
        /* padding: 4px 4px 4px 4px; */
        text-align: center;
    }

    .svgButton {
        box-shadow:inset 0px 0px 15px 3px #23395e;
        background:linear-gradient(to bottom, #2e466e 5%, #415989 100%);
        background-color:#2e466e;
        border-radius:20px;
        border:1px solid #1f2f47;
        display:inline-block;
        cursor:pointer;
        color:#ffffff;
        font-family:Arial;
        font-size:15px;
        padding:10px 13px;
        text-decoration:none;
        text-shadow:0px 1px 0px #263666;
        text-align: -webkit-center;
    }
    .svgButton:hover {
        background:linear-gradient(to bottom, #415989 5%, #2e466e 100%);
        background-color:#415989;
    }
    .svgButton:active {
        position:relative;
        top:1px;
    }

</style>

<script src="ui_svg_graphics/lib/jschannel.js"></script>
<script src="ui_svg_graphics/lib/beautify-html.js"></script>
<script src="ui_svg_graphics/lib/beautify-css.js"></script>

<script type="text/javascript">
    const messageBox = {
        show: function(message, title, faicon, options) {
            options = options || {}
            var msgbox = $('#ui-svg-message-box');
            if (msgbox.length == 0) {
                var msgboxhtml =    '<div id="ui-svg-message-box" title="" class="msgboxOuter" >' +
                                    '  <div id="ui-svg-message-box-icon-div" class="msgboxInner">' +
                                    '    <div class="msgboxInnerLeft">' +
                                    '      <i id="ui-svg-message-box-icon"> </i>' +
                                    '    </div>' +
                                    '  </div>' +
                                    '  <div class="msgboxInner">' +
                                    '    <div id="ui-svg-message-box-text" class="msgboxInnerRight" >' +
                                    '    </div>' +
                                    '  </div>' +
                                    '</div>'
                msgbox = $(msgboxhtml).appendTo('body');
            }
            var icon = msgbox.find("#ui-svg-message-box-icon");
            var iconDiv = msgbox.find("#ui-svg-message-box-icon-div");
            if(faicon && icon && icon.length){
                icon[0].className = "fa fa-4x " + faicon;
                iconDiv.show();
            } else {
                iconDiv.hide();
            }
            var text = msgbox.find("#ui-svg-message-box-text");
            text.html(message);
            msgbox.attr("title",title);
            msgbox.dialog({
                resizable: options.resizable === false ? options.resizable : true,
                height: options.height || 100,
                width: options.width || 400,
                modal: options.modal === false ? options.modal : true,
                buttons: options.buttons,
                close: function() {
                    $(this).dialog("destroy");
                    $(this).empty();//ensure old content is completely removed
                    $(this).remove();
                }
            });
        },
        close: function() {
            $('#ui-svg-message-box').dialog( "close" );
        }
    }
    
    // Collect information for the auto-complete fields
    function updateSvgIdHelpers(node, svgStr) {
        console.log("updateSvgIdHelpers");
        
        // Reset all information that we have previously collected
        node.nonAnimationClasses = [];
        node.animationClasses = [];
        node.animationListClasses = [];
        node.animationIds = [];
        node.animationIdSelectors = [];
        node.nonAnimationIds = [];
        node.nonAnimationIdSelectors = [];
        node.nonAnimationIdsAndActions = [];
        node.animationIdsAndActions = [];

        // To be able to parse the string to a DOM, the SVG element needs to be in the svg namespace (i.e. it needs to have an
        // xmlns attribute with the appropriate value).  Otherwise the DOMParser doesn't know how to handle the SVG tags.
        // Otherwise the querySelectorAll will not work, which means the autocomplete would be empty ...
        svgStr = svgStr.replace(/^<svg([^>]*[^>]*)>/g, function(match, $1, offset, input_string) {
            if ($1.indexOf("http://www.w3.org/2000/svg") < 0) {
                $1 += ' xmlns="http://www.w3.org/2000/svg"';
                $1 += ' xmlns:svg="http://www.w3.org/2000/svg"';
            }

            if ($1.indexOf("http://www.w3.org/1999/xlink") < 0) {
                $1 += ' xmlns:xlink="http://www.w3.org/1999/xlink"';
            }

            return "<svg " + $1 + ">";
        })
        
        // Convert the SVG string into a temporary DOM tree, which allows us to search easily through the SVG.
        // See https://discourse.nodered.org/t/temporary-dom-elements-somewhere-cached/15520
        var svgElement = new DOMParser().parseFromString(svgStr, "image/svg+xml");

        svgElement.querySelectorAll('[class]').forEach(function (element) {
            element.classList.forEach(function (className) {
                if(!className) return;
                var _class = "." + className;
                var ele = element.tagName;
                ele = ele.trim().toLowerCase();
                if (ele == "set" || ele == "animate" || ele == "animatemotion" || ele == "animatecolor" || ele == "animatetransform") {
                    if (node.animationClasses.indexOf(_class) < 0) {
                        node.animationClasses.push(_class)
                    }
                } else {
                    if (node.nonAnimationClasses.indexOf(_class) < 0) {
                        node.nonAnimationClasses.push(_class)
                    }
                }
            })
        })
        svgElement.querySelectorAll('*[id]').forEach(function (element) {
            if(!element.id) return;
            
            var id = element.id;
            var ele = element.tagName;
            ele = ele.trim().toLowerCase();
            if(ele == "style") return;
            if (ele == "set" || ele == "animate" || ele == "animatemotion" || ele == "animatecolor" || ele == "animatetransform") {
                if (node.animationIds.indexOf(id) < 0) {
                    node.animationIds.push(id)
                    node.animationIdSelectors.push("#"+id)
                    node.animationIdsAndActions.push(id)
                    node.animationIdsAndActions.push(id + ".begin");
                    node.animationIdsAndActions.push(id + ".end");
                    node.animationIdsAndActions.push(id + ".repeat(1)");
                }
            } else if(ele != "style" ) {
                if (node.nonAnimationIds.indexOf(id) < 0) {
                    node.nonAnimationIds.push(id);
                    node.nonAnimationIdSelectors.push("#"+id)
                    node.nonAnimationIdsAndActions.push(id + ".click");
                    node.nonAnimationIdsAndActions.push(id + ".dbclick");
                    node.nonAnimationIdsAndActions.push(id + ".change");
                    node.nonAnimationIdsAndActions.push(id + ".contextmenu");
                    node.nonAnimationIdsAndActions.push(id + ".mouseover");
                    node.nonAnimationIdsAndActions.push(id + ".mouseout");
                    node.nonAnimationIdsAndActions.push(id + ".mouseup");
                    node.nonAnimationIdsAndActions.push(id + ".mousedown");
                    node.nonAnimationIdsAndActions.push(id + ".focus");
                    node.nonAnimationIdsAndActions.push(id + ".focusin");
                    node.nonAnimationIdsAndActions.push(id + ".focusout");
                    node.nonAnimationIdsAndActions.push(id + ".blur");
                    node.nonAnimationIdsAndActions.push(id + ".keyup");
                    node.nonAnimationIdsAndActions.push(id + ".keydown");
                    node.nonAnimationIdsAndActions.push(id + ".touchstart");
                    node.nonAnimationIdsAndActions.push(id + ".touchend");
                }
            }
        })
        
        //Get all animation ids specified by the SMIL animations editable list...
        var smilAnimationsList = $("#node-input-animations-container").editableList('items');
        smilAnimationsList.each(function(i) {
            var aid = $(this).find(".node-input-animation-id").val();    
            var cv = $(this).find(".node-input-animation-classValue").val();    
                        
            if (cv && node.animationListClasses.indexOf(cv) < 0) {
                node.animationListClasses.push(cv);
            }
            if(!aid) return;            
            if (node.animationIds.indexOf(aid) < 0) {
                node.animationIds.push(aid);
                node.animationIdsAndActions.push(aid + ".begin");
                node.animationIdsAndActions.push(aid + ".end");
                node.animationIdsAndActions.push(aid + ".repeat(1)");
            }
        });
    }
    
    // resize the current tab content divs to their available height
    function updateEditorHeight(node) {
        // Calculate the height that is being occupied by the other html elements (i.e. outside of the tab content)
        var formRows = $("#dialog-form>div:not(#node-svg-tabs-content)");
        var height = $("#dialog-form").height() - 5;
        for (let i=0; i < formRows.length; i++) {
            height -= $(formRows[i]).outerHeight(true);
        }
        
        // Set the size of the tab content, to fill the area that is left over
        $("#node-svg-tabs-content").css("height",height+"px");
        
        // Now resize the items (inside the tab content), which have css class "form-row-auto-height"
        var tabs = $('.node-svg-tab-content');
        for (let index = 0; index < tabs.length; index++) {
            let tab = $(tabs[index]);
            tab.css("height", height+"px");
            let expandRow = $(tab.find('.form-row-auto-height'));
            if(expandRow && expandRow.length){
                let tabHeight = height;
                let childRows = tab.find('.form-row:not(.form-row-auto-height)');
                for (let i=0; i<childRows.size(); i++) {
                    tabHeight -= $(childRows[i]).outerHeight(true);
                }
                let ol = $(expandRow.find(".red-ui-editableList-list"));
                if(ol && ol.length){
                    ol.editableList("height",tabHeight);
                } else {
                    expandRow.css("height",tabHeight+"px");
                }
            } 
        }
        
        // If there is an ACE editor (for CSS or SVG) visible on the current tab, then that should get a correct height either.
        // Note that their height depends on whether they are currently being displayed in fullscreen mode or not.
        if ( node.visibleEditor ) {
            // Is the visible editor in full-screen?
            node.fullscreen = document.fullscreenElement ? true : false;

            // Determine whether the svg or css editor is currently being displayed
            var editorType;
            switch(node.currentTabId) {
                case "node-svg-tab-source":
                    editorType = "source"; // SVG source
                    break;
                case "node-svg-tab-css":
                    editorType = "css";
                    break;
            }

            var rows = $("#node-svg-tab-"+editorType+">div:not(.node-"+editorType+"-editor-row)");
            var height = $("#node-svg-tab-"+editorType).height() - 25;
            for (var i=0; i<rows.size(); i++) {
                height = height - $(rows[i]).outerHeight(true);
            }
            if ($('#node-input-templateScope').val() === "global") { height += 232; }
           
            if (node.fullscreen) {
                $('#node-expand-svg-'+editorType).html('<i class="fa fa-compress"></i>')//compress icon
            } else {               
                $('#node-expand-svg-'+editorType).html('<i class="fa fa-expand"></i>')//expand icon
            }
            
            // Set the height of the edit box
            $('#node-input-svg-'+editorType).css('height',height+'px');
            
            // Make sure the visible ACE editor content will match its new edit box size
            node.visibleEditor.resize();
        }
        $(".node-input-clickable-payload").typedInput('width');//layout workaround until NR V1 https://discourse.nodered.org/t/toggle-visibility-of-typedinput-field-layout-issue/12756/11
    } 
    function getAnimationObjectFromFormRow(ele){
        var row = $(ele);
        var id            = row.find(".node-input-animation-id").val();
        var targetId      = row.find(".node-input-animation-targetId").val();
        var classValue    = row.find(".node-input-animation-classValue").val();
        var attributeName = row.find(".node-input-animation-attributeName").val();
        var transformType = row.find(".node-input-animation-transformType").val();
        var fromValue     = row.find(".node-input-animation-fromValue").val();
        var toValue       = row.find(".node-input-animation-toValue").val();
        var trigger       = row.find(".node-input-animation-trigger").val();
        var duration      = row.find(".node-input-animation-duration").val();
        var durationUnit  = row.find(".node-input-animation-durationUnit").val();
        var repeatCount   = row.find(".node-input-animation-repeatCount").val();
        var end           = row.find(".node-input-animation-end").val();
        var delay         = row.find(".node-input-animation-delay").val();
        var delayUnit     = row.find(".node-input-animation-delayUnit").val();
        var otherId       = row.find(".node-input-animation-otherId").val();
        var custom        = row.find(".node-input-animation-custom").val();        
        return {id:id, targetId:targetId, classValue:classValue, attributeName:attributeName, transformType:transformType, fromValue:fromValue, toValue:toValue, trigger:trigger, duration:duration, durationUnit:durationUnit, repeatCount:repeatCount, end:end, delay:delay, otherId:otherId, delayUnit:delayUnit, custom:custom};
    }
    function getBindingFromFormRow(ele){
        var row = $(ele);
        return {
            selector : row.find(".node-input-binding-selector").val(),
            bindSource : row.find(".node-input-binding-source").val(),
            bindType : row.find(".node-input-binding-type").val(),
            attribute : row.find(".node-input-binding-attribute").val()
        };
    }
    
    const DEFAULT_CSS_SVG_NODE = 
`div.ui-svg svg{
    color: var(--nr-dashboard-widgetColor);
    fill: currentColor !important;
}
div.ui-svg path {
    fill: inherit;
}`;
    
    RED.nodes.registerType('ui_svg_graphics',{
        category: '面板',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {
                value: 0,
                validate: function(v) {
                    var valid = true
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()|| this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},
            height: {value: 0},
            svgString: {value: '<svg x="0" y="0" height="100" viewBox="0 0 100 100" width="100" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n' +
                                    '<!-- 在此处添加您的SVG形状（圆形、矩形等） -->\n' +
                                    '<!--或者删除所有内容，如果你想粘贴整个图形（<svg…>…</svg>）。-->\n' +
                                '</svg>'},
            clickableShapes: {value: []},
            javascriptHandlers: {value: []},
            smilAnimations: {value: []},
            bindings: {value: []},
            showCoordinates: {value: false},
            autoFormatAfterEdit: {value: false},
            showBrowserErrors: {value: false},
            showBrowserEvents: {value: false},
            enableJsDebugging: {value: false},
            sendMsgWhenLoaded: {value: false},
            noClickWhenDblClick: {value: false},
            outputField: {value: "payload"},
            editorUrl: {value: "//drawsvg.org/drawsvg.html"},
            //showMouseLines: {value: false},
            directory: {value: ""},
            panning: {value: "disabled"},
            zooming: {value: "disabled"},
            panOnlyWhenZoomed: {value: false},
            doubleClickZoomEnabled: {value: false}, 
            mouseWheelZoomEnabled: {value: false}, 
            dblClickZoomPercentage: {value: 150, validate: function(v) { return !v || (!isNaN(v) && v >= 100)} },
            cssString: {value: DEFAULT_CSS_SVG_NODE},
            name: {value: ''}
        },
        inputs:1,
        outputs:1,
        icon: "svg.png",
        align: 'left',
        paletteLabel:"SVG图片",
        label: function() {
            return this.name || "SVG图片";
        },
        oneditprepare: function() {
            var node = this;
            
            // Old nodes might not have a dblClickZoomPercentage
            $('#node-input-dblClickZoomPercentage').val(this.dblClickZoomPercentage || 150);

            // Make sure the autocomplete fields at least refer to Iterable node fields...
            // See https://github.com/bartbutenaers/node-red-contrib-ui-svg/issues/33
            node.nonAnimationClasses = [];
            node.animationClasses = [];
            node.animationListClasses = [];
            node.animationIds = [];
            node.animationIdSelectors = [];
            node.nonAnimationIds = [];
            node.nonAnimationIdSelectors = [];
            node.nonAnimationIdsAndActions = [];
            node.animationIdsAndActions = [];
            
            // List of animatable attributes
            node.attrList = [
                'clipPathUnits', 'color', 'cx', 'cy', 'd', 'display', 'dx', 'dy', 'fill', 'fx', 'fy', 'gradientTransform', 'gradientUnits', 
                'height', 'lengthAdjust', 'markerHeight', 'markerUnits', 'markerWidth', 'maskContentUnits', 'maskUnits', 'method', 'offset', 
                'orient', 'pathLength', 'patternContentUnits', 'patternTransform', 'patternUnits', 'points', 'preserveAspectRatio', 'r', 
                'refX', 'refY', 'rotate', 'rx', 'ry', 'spacing', 'spreadMethod', 'startOffset', 'textLength', 'transform', 'viewBox', 
                'visibility', 'width', 'x', 'x1', 'x2', 'y', 'y1', 'y2'
            ]
            
            // List of presentation attributes, which are used to style SVG elements and can be used as CSS properties.
            // SVG presentation attributes are CSS properties that can be used as attributes on SVG elements.
            // For example there are a couple of ways to give a circle a yellow color:
            // 1) CSS (inline) style attribute: <circle style="fill: yellow;"/>
            // 2) CSS (external) style:         circle {fill: yellow}
            // 3) Presentational attribute:     <circle fill="yellow"/>
            // The priority order is: 1 overrules 2, and 2 overrules 1
            // So they accomplish the same, but - since the Node-RED dashboard applies its own styles - it is safer to use '1'.
            // See https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/Presentation
            node.presentationAttrList = [
                'alignment-baseline', 'baseline-shift', 'clip', 'clip-path', 'clip-rule', 'color', 'color-interpolation', 'color-interpolation-filters', 
                'color-profile', 'color-rendering', 'cursor', 'direction', 'display', 'dominant-baseline', 'enable-background', 'fill', 'fill-opacity', 
                'fill-rule', 'filter', 'flood-color', 'flood-opacity', 'font-family', 'font-size', 'font-size-adjust', 'font-stretch', 'font-style', 
                'font-variant', 'font-weight', 'glyph-orientation-horizontal', 'glyph-orientation-vertical', 'image-rendering', 'kerning', 'letter-spacing', 
                'lighting-color', 'marker-end', 'marker-mid', 'marker-start', 'mask', 'opacity', 'overflow', 'pointer-events', 'shape-rendering', 'solid-color', 
                'solid-opacity', 'stop-color', 'stop-opacity', 'stroke', 'stroke-dasharray', 'stroke-dashoffset', 'stroke-linecap', 'stroke-linejoin', 
                'stroke-miterlimit', 'stroke-opacity', 'stroke-width', 'text-anchor', 'text-decoration', 'text-rendering', 'transform', 'unicode-bidi', 
                'vector-effect', 'visibility', 'word-spacing', 'writing-mode'
            ]
            
            node.initialised = false;
            window.node_ace_svg_editor = null;
            window.node_ace_css_editor = null;
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            if (typeof this.templateScope === 'undefined') {
                this.templateScope = 'local';
                $('#node-input-templateScope').val(this.templateScope);
            }
            $('#node-input-templateScope').on('change', function() {
                if ($('#node-input-templateScope').val() === 'global') {
                    $('#template-row-group, #template-row-size, #template-pass-store').hide();
                    node._def.defaults.group.required = false;
                }
                else {
                    $('#template-row-group, #template-row-size, #template-pass-store').show();
                    node._def.defaults.group.required = true;
                }
                
                if ( node.visibleEditor ) {
                    // Get the id of the editor container DIV element
                    var editorContainerId = node.visibleEditor.container.parentElement.id;
                    
                    // Determine whether the svg or css editor is currently being displayed
                    var editorType;
                    switch(editorContainerId) {
                        case "node-input-svg-source":
                            editorType = "svg";
                            break;
                        case "node-input-svg-css":
                            editorType = "css";
                            break;
                    }
                    
                    var rows = $("#dialog-form>div:not(.node-"+editorType+"-editor-row)");
                    var height = $("#dialog-form").height();
                    for (var i=0; i<rows.size(); i++) {
                        height = height - $(rows[i]).outerHeight(true);
                    }
                    
                    if ($('#node-input-templateScope').val() === "global") { height += 240; }
                    var editorRow = $("#dialog-form>div.node-"+editorType+"-editor-row");
                    height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
                    $(".node-"+editorType+"-editor").css("height",height+"px");
                    node.visibleEditor.resize();
                }
            })
   
            // Show tabsheets
            node.tabs = RED.tabs.create({
                id: "node-svg-tabs",
                onchange: function(tab) {
                    node.currentTabId = tab.id;
                    
                    //console.log("tabs.onchange",tab);
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-svg-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    
                    node.visibleEditor = null;
                    
                    if(tab.id == "node-svg-tab-animations" || tab.id == "node-svg-tab-clickable" || tab.id == "node-svg-tab-binding" || tab.id == "node-svg-tab-javascript"){
                        let svgStr = node.svgEditor ? node.svgEditor.getValue() : ""; 
                        try {
                            // When tabsheet changes, all autocomplete sources should be updated (since element ids, ... might have changed)
                            updateSvgIdHelpers(node, svgStr);    
                        } 
                        catch (error) {
                            console.error(error)
                        }
                    }
                    else if (tab.id == "node-svg-tab-source") {
                        node.visibleEditor = node.svgEditor;
                    }
                    else if (tab.id == "node-svg-tab-css") {
                        node.visibleEditor = node.cssEditor;
                    }
                    else if (tab.id == "node-svg-tab-editor") {
                    }
                    
                    // Make sure the content of the tabsheet nicely fills the available area
                    updateEditorHeight(node);
                }
            });
            node.tabs.addTab({
                id: "node-svg-tab-editor",
                label: "编辑"
            });
            node.tabs.addTab({
                id: "node-svg-tab-source",
                label: "SVG"
            });
            node.tabs.addTab({
                id: "node-svg-tab-animations",
                label: "动画"
            });
            node.tabs.addTab({
                id: "node-svg-tab-clickable",
                label: "事件"
            });
            node.tabs.addTab({
                id: "node-svg-tab-javascript",
                label: "JS"
            });
            node.tabs.addTab({
                id: "node-svg-tab-binding",
                label: "绑定"
            });
            node.tabs.addTab({
                id: "node-svg-tab-settings",
                label: "设置"
            });
            node.tabs.addTab({
                id: "node-svg-tab-css",
                label: "CSS"
            }); 
            function updateSvgEditorButton() {
                var svgEditorButton = $("#node-display-svg-popup");
                var editorUrlMissing = $("#node-display-svg-popup-no-url");
                if ($("#node-input-editorUrl").val().trim()) {
                    svgEditorButton.show();
                    editorUrlMissing.hide();
                } else {
                    svgEditorButton.hide();
                    editorUrlMissing.show();
                }
            }
            updateSvgEditorButton();
            var selectSettingsTab = function () {
                this.tabs.activateTab("node-svg-tab-settings")
            }.bind(node)
            //add click event to "settings" link in the "no url" warning
            $("#gotoSettingsButton").click(selectSettingsTab);

            this.fullscreen = false;
            
            this.svgEditor = RED.editor.createEditor({
                id: 'node-input-svg-source',
                mode: 'ace/mode/html',
                value: $("#node-input-svgString").val()
            });
            node.svgEditor.setFontSize(14); 
            window.node_ace_svg_editor = node.svgEditor;

            this.cssEditor = RED.editor.createEditor({
                id: 'node-input-svg-css',
                mode: 'ace/mode/css',
                // Apply a default CSS string to older nodes (version 2.2.4 and below)
                value: $("#node-input-cssString").val() || DEFAULT_CSS_SVG_NODE
            });
            node.cssEditor.setFontSize(14); 
            window.node_ace_css_editor = node.cssEditor;
            
            RED.library.create({
                url:"uitemplates", // where to get the data from
                type:"ui_template", // the type of object the library is for
                editor:this.svgEditor, // the field name the main text body goes to
                mode:"ace/mode/svg",
                fields:['name']
            });
            this.svgEditor.focus();
            
            var fullScrSvgElement = $('#node-svg-tab-source')[0];
            var svgFsr = fullScrSvgElement.requestFullscreen || fullScrSvgElement.mozRequestFullScreen || fullScrSvgElement.webkitRequestFullscreen || fullScrSvgElement.msRequestFullScreen;
            if(svgFsr){
                $('#node-expand-svg-source').click(function(e) {
                    e.preventDefault()
                    if (node.fullscreen === false) {
                        if (svgFsr) {
                            svgFsr.call(fullScrSvgElement);//triggers oneditresize()
                        }
                    } else {
                        document.exitFullscreen();//triggers oneditresize()
                    }
                })
            } else {
                $('#node-expand-svg-source').hide();
            }
            
            var fullScrCssElement = $('#node-svg-tab-css')[0];
            var cssFsr = fullScrCssElement.requestFullscreen || fullScrCssElement.mozRequestFullScreen || fullScrCssElement.webkitRequestFullscreen || fullScrCssElement.msRequestFullScreen;
            if(cssFsr){
                $('#node-expand-svg-css').click(function(e) {
                    e.preventDefault()
                    if (node.fullscreen === false) {
                        if (cssFsr) {
                            cssFsr.call(fullScrCssElement);//triggers oneditresize()
                        }
                    } else {
                        document.exitFullscreen();//triggers oneditresize()
                    }
                })
            } else {
                $('#node-expand-svg-css').hide();
            }
            
            function addPropertyRow(container, propertyName) {
                var propertyRow = $('<div/>',{style:"margin-top:8px;"}).appendTo(container);
                $('<div/>', {style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                .text(propertyName)
                .appendTo(propertyRow);
                
                return propertyRow;
            }
            
            function getTitle(animation) {
                if (animation && animation.id != "") {
                    return "动画 ( " + animation.id + " : '" + animation.targetId + "' : '" + animation.attributeName + "' )";
                }
                else {
                    return "动画 ( 未知 id )";
                }
            }
            
            function updateTitle(titleField, ele){
                var par = $(ele).parent().parent();
                var anim = getAnimationObjectFromFormRow(par);
                var newTitle = getTitle(anim);
                titleField.text(newTitle);
            }
            
            function tagSplit(val) {
                return val.split(/;\s*/);
            }
            
            function extractLastTag(term) {
                return tagSplit(term).pop();
            }
            
            var actionOptions = {
                //https://www.w3.org/TR/2015/WD-SVG2-20150407/interact.html#SVGEvents
                'click':'点击',//A click is defined as a mousedown and mouseup over the same screen location. Works on tablet too.
                'dblclick':'双击',
                'contextmenu':'上下文菜单',
                'mousedown':'鼠标向下',//Occurs when the pointing device button is pressed over an element.
                'mouseup':'鼠标向上',//Occurs when the pointing device button is released over an element.
                'mouseover':'鼠标悬停',//Occurs when the pointing device is moved onto an element.
                'mouseout':'鼠标出来', //Occurs when the pointing device is moved away from an element
                //'mousemove':'mousemove', //Occurs when the pointing device is moved while it is over an element.
                'focus':'焦点',//Occurs when an element receives focus.
                'focusin':'向内焦点',//Occurs when an element is about to receive focus
                'focusout':'向外焦点',//Occurs when an element is about to lose focus.
                'blur':'模糊',//Occurs when an element loses focus.
                'keydown':'按键按下',//Occurs when a key is pressed down
                'keyup':'按键弹起',
                //https://www.w3.org/TR/touch-events/#list-of-touchevent-types
                'touchstart':'触摸启动', //mobile/tablet only
                'touchend':'触摸结束', //mobile/tablet only
                // 'touchmove':'touchmove',
                // 'touchcancel':'touchcancel',
                'change':'变更'
            }
            
            // Create a table of (SMIL) animations
            // Columns: element id - attributeName - from - to - duration - repeatCount - end
            var smilAnimationsList = $("#node-input-animations-container").css('min-height','150px').css('min-width','400px').editableList({
                addItem: function(container, i, animation) {
                    // By default the list items will be compressed, so show the expand icon
                    var expandIcon = "fa fa-angle-right";
                    
                    // When animation === {} then we have a new list item (i.e. user pressed the addItem button)
                    if (Object.keys(animation).length === 0) {
                        // Initialize new items in the list.
                        animation = {
                            id            : "", 
                            targetId      : "",
                            attributeName : "",
                            transformType : "rotate",
                            classValue    : "",
                            fromValue     : "",
                            duration      : 1,
                            durationUnit   : "s",
                            repeatCount   : 0,
                            end           : "restore",
                            trigger       : "msg",
                            delay         : 1,
                            delayUnit     : "s",
                            otherId       : "",
                            custom        : ""
                        };
                        
                        // New list items should be expanded by default, so show a compress icon.
                        // This way the user becomes aware which properties the new widget offers...
                        expandIcon = "fa fa-angle-down";
                    }
                    
                    if(animation.expand){
                        delete animation.expand
                        expandIcon = "fa fa-angle-down";
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    
                    var headerRow = $('<div/>').appendTo(container);
                    
                    // Show a click-able expand/compress icon before each header row.
                    var expandButton = $('<span/>', {style: "margin-left:5px; margin-right:10px;"}).html('<i class="' + expandIcon + '"></i>').appendTo(headerRow);
                    
                    // The header line title depends on the animation id
                    var title = getTitle(animation);
                    
                    var titleField = $('<span/>', {style: "margin-left:10px; margin-right:10px; font-weight:Bold"}).text(title).appendTo(headerRow);
                    titleField.click(function(evt){
                        expandButton.trigger( "click" )
                    })
                    // The COMMON ROWS contain the common animation properties:
                    // - Animation id
                    // - Target id
                    // - Attribute name + (optional) transformType
                    // - From value
                    // - To value
                    // - Duration + DurationUnit
                    // - Repeat count
                    // - End
                    // - Trigger type
                    
                    // Add an 'animation id' property row
                    var animationIdRow = addPropertyRow(container, "动画 id");
                    var animationIdField = $('<input/>', {class: "node-input-animation-id", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(animationIdRow);
                    animationIdField.val(animation.id);
                    animationIdField.on("change", function(){
                        updateTitle(titleField, this)
                    });
                    $('<span/>').text('%').appendTo(animationIdField);         
                                    
                    // Add a 'target id' property row
                    var targetIdRow = addPropertyRow(container, "目标元素 Id");
                    var targetIdField = $('<input/>', {class: "node-input-animation-targetId", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(targetIdRow);
                    targetIdField.val(animation.targetId);
                    targetIdField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(targetIdField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            targetIdField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                source: function(req, add){
                                    add($.ui.autocomplete.filter(node.nonAnimationIds || [] , req.term));
                                }
                            });
                        }
                    });                     
                    targetIdField.on("change", function(){
                        updateTitle(titleField, this)
                    });
                    $('<span/>').text('%').appendTo(targetIdField);
                    
                    // Add a 'class' property row
                    var classValueRow = addPropertyRow(container, "类");
                    var classValueField = $('<input/>', {class: "node-input-animation-classValue", style: "width:180px; margin-right:10px;", type: "text", placeholder: "类"}).appendTo(classValueRow);
                    classValueField.val(animation.classValue);
                    classValueField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(classValueField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            classValueField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                source: function(req, add){
                                    add($.ui.autocomplete.filter(node.animationListClasses || [],req.term));
                                }
                            });
                        }
                    });                    
                    $('<span/>').text('%').appendTo(classValueField);
                    
                    // Add an 'attribute name' property row
                    var attributeNameRow = addPropertyRow(container, "属性名称");
                    var attributeNameField = $('<input/>', {class: "node-input-animation-attributeName", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(attributeNameRow);
                    attributeNameField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(attributeNameField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            attributeNameField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                source: function(req, add){
                                    add($.ui.autocomplete.filter(node.attrList || [], req.term));
                                }
                            });
                        }
                    });                      
                    attributeNameField.on("change", function(){
                        updateTitle(titleField, this);
                        
                        // Only show the transform type dropdown when the attribute name is 'transform'
                        if (this.value === "transform") {
                            transformTypeField.show();
                        }
                        else {
                            transformTypeField.hide();
                        }
                    });
                    attributeNameField.val(animation.attributeName);
                    $('<span/>').text('%').appendTo(attributeNameField);
                    // Add a transform 'type' (after the attribute name)
                    var transformTypeField = $('<select/>', {class: "node-input-animation-transformType", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(attributeNameRow);
                    transformTypeField.append($('<option>', {value: "rotate"    , text: 'Rotate'}));
                    transformTypeField.append($('<option>', {value: "scale"     , text: 'Scale'}));
                    transformTypeField.append($('<option>', {value: "translate" , text: 'Translate'}));
                    transformTypeField.append($('<option>', {value: "skewX"     , text: 'Skew X'}));
                    transformTypeField.append($('<option>', {value: "skewY"     , text: 'Skew Y'}));
                    transformTypeField.val(animation.transformType || "rotate");
                    $('<span/>').text('%').appendTo(transformTypeField);                   
                    // Trigger the attribute name change event handler, to make sure the transform type is shown or hided at startup
                    attributeNameField.change();
                    
                    // Add a 'from / to value' property row
                    var fromToValueRow = addPropertyRow(container, "开始 / 结束");
                    var fromValueField = $('<input/>', {class: "node-input-animation-fromValue", style: "width:180px; margin-right:10px;", type: "text", placeholder: "开始"}).appendTo(fromToValueRow);
                    fromValueField.val(animation.fromValue);
                    $('<span/>').text('%').appendTo(fromValueField);
                    // Add a 'to value' property row
                    var toValueField = $('<input/>', {class: "node-input-animation-toValue", style: "width:180px; margin-right:10px;", type: "text", placeholder: "结束"}).appendTo(fromToValueRow);
                    toValueField.val(animation.toValue);
                    $('<span/>').text('%').appendTo(toValueField);
                    // Add a 'duration' property row
                    var durationRow = addPropertyRow(container, "持续时间");
                    var durationField = $('<input/>', {class: "node-input-animation-duration", style: "width:180px; margin-right:10px;", type: "number"}).appendTo(durationRow);
                    durationField.val(animation.duration);
                    $('<span/>').text('%').appendTo(durationField);
                    var delayUnitField = $('<select/>', {class: "node-input-animation-durationUnit", style: "width:120px; margin-right:10px;", type: "text"}).appendTo(durationRow);
                    delayUnitField.append($('<option>', {value: "ms", text: '毫秒'}));
                    delayUnitField.append($('<option>', {value: "s", text: '秒'}));
                    delayUnitField.append($('<option>', {value: "min", text: '分'}));
                    delayUnitField.val(animation.durationUnit || "s");
                    
                    // Add a 'repeat count' property row
                    var repeatCountRow = addPropertyRow(container, "重复计数");
                    var repeatCountField = $('<input/>', {class: "node-input-animation-repeatCount", style: "width:180px; margin-right:10px;", type: "number"}).appendTo(repeatCountRow);
                    repeatCountField.val(animation.repeatCount);
                    $('<span/>').text('%').appendTo(repeatCountField);       
                    
                    // Add a 'animation end' property row
                    var endRow = addPropertyRow(container, "动画结束");
                    var endField = $('<select/>', {class: "node-input-animation-end", style: "width:180px; margin-right:10px;", type: "text"}).appendTo(endRow);
                    endField.append($('<option>', {value: "freeze", text: '冻结新值'}));
                    endField.append($('<option>', {value: "restore", text: '恢复原始值'}));
                    endField.val(animation.end || "restore");//SMIL default is restore                    
                    
                    // Add a 'trigger' property row
                    var triggerRow = addPropertyRow(container, "触发");
                    var triggerField = $('<select/>',{class:"node-input-animation-trigger", style:"width:180px; margin-right:10px;"}).appendTo(triggerRow);
                    triggerField.append($("<option></option>").val('msg').text("输入消息"));
                    triggerField.append($("<option></option>").val('time').text("时间延迟"));
                    //triggerField.append($("<option></option>").val('anim').text("Other animation"));
                    triggerField.append($("<option></option>").val('cust').text("自定义"));
                    triggerField.val(animation.trigger);
    
                    expandButton.click(function(e) {
                        e.preventDefault();
                        
                        // Switch the icon between expand and compress
                        if (this.firstElementChild.className === "fa fa-angle-right") {
                            this.firstElementChild.className = "fa fa-angle-down";
                        }
                        else {
                            this.firstElementChild.className = "fa fa-angle-right";
                        }
                    
                        // Only show the relevant widget type properties
                        triggerField.change();
                    });
                    
                    // The (common) row ends here ...
                    // The OTHER rows will only be visible depending on the animation trigger type:
                    // - Delay
                    // - Other id
                    // - Custom
            
                    // Add a 'delay' property row
                    var delayRow = addPropertyRow(container, "延时");
                    var delayField = $('<input/>', {class: "node-input-animation-delay", style: "width:160px; margin-right:10px;", type: "number"}).appendTo(delayRow);
                    delayField.val(animation.delay);
                    $('<span/>').text('%').appendTo(delayField);
                    var delayUnitField = $('<select/>', {class: "node-input-animation-delayUnit", style: "width:120px; margin-right:10px;", type: "text"}).appendTo(delayRow);
                    delayUnitField.append($('<option>', {value: "ms", text: '毫秒'}));
                    delayUnitField.append($('<option>', {value: "s", text: '秒'}));
                    delayUnitField.append($('<option>', {value: "min", text: '分'}));
                    delayUnitField.val(animation.delayUnit || "s");
                    
                    // Add a 'custom' property row
                    var customRow = addPropertyRow(container, "自定义");
                    var customField = $('<input/>', {class: "node-input-animation-custom", style: "width:70%; margin-right:10px;", type: "text"}).appendTo(customRow);
                    customField.val(animation.custom);
                    customField.on("keydown", function (event) {
                        if($(this).autocomplete("instance").menu.active){
                            var appendChar = "; ";
                            var takeInput = true;
                            switch (event.keyCode) {
                                case $.ui.keyCode.RIGHT:
                                appendChar = "";
                                break;
                                case 186:
                                appendChar = "; ";
                                break;
                                case $.ui.keyCode.PERIOD:
                                appendChar = ".";
                                break;
                                default:
                                takeInput = false;
                            }
                            
                            if (event.keyCode === $.ui.keyCode.TAB) {
                                event.preventDefault();// don't navigate away from the field on tab when selecting an item
                            } else if (takeInput) {
                                let terms =  tagSplit(this.value);
                                let selected = $(this).autocomplete("instance").menu.active.text()
                                terms.pop();// remove the current input 
                                terms.push(selected + appendChar); // add the selected item
                                this.value = terms.join("; ");
                                event.preventDefault();// don't navigate away from the field
                            }
                        }
                    })
                    customField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(customField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            customField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                minLength: 0,
                                source: function (request, response) {
                                    //TODO: Consider how to handle editing in middle of string
                                    //currently, the last tag (after last ;) is used.
                                    let list;
                                    let lastTag = extractLastTag(request.term);
                                    if(lastTag.includes(".")){
                                        list = [...node.nonAnimationIdsAndActions,...node.animationIdsAndActions]; 
                                    } else {
                                        list = [...node.nonAnimationIds, ...node.animationIds]; 
                                    }
                                    // delegate back to autocomplete, but extract the last term
                                    response($.ui.autocomplete.filter(list, lastTag));
                                },
                                focus: function () {
                                    // prevent value inserted on focus
                                    return false;
                                },
                                select: function (event, ui) {
                                    var terms = tagSplit(this.value);
                                    terms.pop();// remove the current input 
                                    terms.push(ui.item.value); // add the selected item
                                    // add placeholder to get the comma-and-space at the end
                                    terms.push("");
                                    this.value = terms.join("; ");
                                    return false;
                                }
                            });
                        }
                    });                        
                    $('<span/>').text('%').appendTo(customField);
                    customRow.append($("<i />", {class:"fa fa-question", title:"按下可选择，右键可接受，点可访问属性，分号/inter/tab可完成输入。"}));
                    
                    //add duplicate button
                    var duplicateButton = $('<a/>', {class: "red-ui-editableList-item-remove red-ui-button red-ui-button-small", style: "margin-right: 28px",  title: "复制此条目"}).appendTo(container);
                    duplicateButton.html('<i class="fa fa-clone"></i>')
                    var anim = animation;
                    var animList = smilAnimationsList;
                    duplicateButton.click(function(evt){
                        var duplicate = getAnimationObjectFromFormRow($(this).parent());
                        duplicate.id += "_copy";
                        duplicate.expand = true;
                        animList.editableList('addItem', duplicate);
                    })
                    
                    // When the trigger type changes, only the relevant property rows should be visible
                    triggerField.change(function() {
                        var triggerType = $(this).val();
                        
                        animationIdRow.hide();
                        targetIdRow.hide();
                        attributeNameRow.hide();
                        classValueRow.hide();
                        fromToValueRow.hide();
                        durationRow.hide();
                        repeatCountRow.hide();
                        endRow.hide();
                        triggerRow.hide();
                        delayRow.hide();
                        //otherIdRow.hide();
                        customRow.hide();
                        
                        // When the button shows a 'compress' icon, this means that the list item is currently expanded
                        // (i.e. that all relevant property rows should be visible)
                        if (expandButton.children()[0].className === "fa fa-angle-down") {
                            // The (common) header rows should be visible for all widget types
                            animationIdRow.show();
                            targetIdRow.show();
                            attributeNameRow.show();
                            classValueRow.show();
                            fromToValueRow.show();
                            durationRow.show();
                            repeatCountRow.show();
                            endRow.show();
                            triggerRow.show();
                        
                            // Some other property rows should only be visible for specific trigger types
                            switch (triggerType) {
                                case 'msg':
                                    // No extra property rows to show
                                    break;
                                case 'time':
                                    delayRow.show();                                   
                                    break;
                                case 'cust':
                                    customRow.show();
                                    break;
                            }
                        }
                    });
                    
                    // Only show the relevant widget type properties
                    triggerField.change();
                },                    
                removable: true,
                sortable: false
            });
            
            // Show all the animations (stored in this node) into the editableList
            if (this.smilAnimations) {
                this.smilAnimations.forEach(function (smilAnimation, index) {
                    smilAnimationsList.editableList('addItem', smilAnimation);
                });
            }

            // Create a table of clickable shapes
            const supportedPayloadTypes = ['flow', 'global', 'str', 'num', 'bool', 'json', 'date'];
            const defaultPayloadType = "str";
            var clickableShapesList = $("#node-input-clickable-container").css('min-height','150px').css('min-width','450px').editableList({
                // Apply css to the parent div to have margins, to make sure the percentages of the headers match those of the html elements below.
                // Thanks to hotNipi for this tip !!!
                header: $("<div>").css({"margin-left":"28px","margin-right":"10x","padding-right":"0px"}).append($.parseHTML(
                   "<div style='width:17%; display: inline-grid'><b>选择器</b></div>" +
                   "<div style='width:25%; display: inline-grid'><b>活动</b></div>" +
                   "<div style='width:30%; display: inline-grid' id='node-input-columnPayload'><b>msg.payload</b></div>" +
                   "<div style='width:17%; display: inline-grid'><b>msg.topic</b></div>")),
                addItem: function(container, i, clickableShape) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    
                    // Column 1 : Add an input field (type string) to the new row, that represents the selector for this event to operate on.
                    var selectorField = $('<input/>',{class:"node-input-clickable-selector",type:"text",placeholder:"元素选择器"}).css({"width":"17%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    selectorField.val(clickableShape.selector);
                    selectorField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(selectorField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            selectorField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                source: function(req, add){
                                    var list = [...node.nonAnimationIdSelectors,...node.nonAnimationClasses] || []
                                    add($.ui.autocomplete.filter(list , req.term));
                                }
                            });
                        }
                    });                     
                    
                    // Column 2 : Add an input field (type option) to the new row, that represents the action type 
                    var actionField = $('<select/>',{class:"node-input-clickable-action",type:"text",placeholder:"点击"}).css({"width":"25%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    for(var val in actionOptions) {
                        $('<option />', {value: val, text: actionOptions[val]}).appendTo(actionField);
                    }
                    actionField.val(clickableShape.action || "click");
                    
                    // Column 3 : Add a input field (type string) to the new row, that represents the msg.payload content 
                    var payloadField = $('<input/>',{class:"node-input-clickable-payload",type:"text",placeholder:"有效数据"}).css({"width":"30%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var payloadTypeField = $('<input/>',{class:"node-input-clickable-payloadType",type:"hidden"}).appendTo(row);
                    var payloadType = supportedPayloadTypes.includes(clickableShape.payloadType) ? clickableShape.payloadType : defaultPayloadType;
                    payloadField.typedInput({
                        default: defaultPayloadType,
                        typeField: payloadTypeField,
                        types: supportedPayloadTypes
                    });
                    payloadField.typedInput("type", payloadType);              
                    payloadField.typedInput("value", clickableShape.payload);  
                    // Column 4 : Add an input field (type string) to the new row, that represents the msg.topic content
                    var topicField = $('<input/>',{class:"node-input-clickable-topic",type:"text",placeholder:"主题"}).css({"width":"17%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    topicField.val(clickableShape.topic);
                    
                    // When there is not yet a topic or payload, the target Id should be cloned (when complete) to the topic and payload (as a default value).
                    selectorField.on("change", function(){
                        
                        if (payloadType === "str" && !payloadField.typedInput("value")) {
                            payloadField.typedInput('value',$(this).val());
                        }
                        
                        if (!topicField.val() || topicField.val() === "") {
                            topicField.val($(this).val());
                        }
                    });
                },
                removable: true,
                sortable: true,
                buttons: [{
                    label: "<script>alert('hi');<\/script>",
                    icon: "fa fa-star"
                },
                {
                    icon: "fa fa-star",
                    click: function(evt) { 
                        alert("无图标");
                    }
                }]
            });
            
            // Show all the clickable shapes (stored in this node) into the editableList
            if (this.clickableShapes) {
                this.clickableShapes.forEach(function (clickableShape, index) {
                    // CAUTION: The "targetId" now contains the CSS selector (instead of the element id).  
                    //          But we cannot rename it anymore in the stored json, since we don't want to have impact on existing flows!!!
                    //          This is only the case for clickable shapes, not for animations (since there is no CSS selector possible)...
                    clickableShapesList.editableList('addItem', {selector:clickableShape.targetId, action:clickableShape.action, payload:clickableShape.payload, payloadType:clickableShape.payloadType, topic:clickableShape.topic});
                });
            }
            
            // Create a table of Javascript event handlers
            var javascriptHandlersList = $("#node-input-javascript-container").css('min-height','150px').css('min-width','450px').editableList({
                header: $("<div>").append($.parseHTML(
                   "<div style='width:17%; margin-left:5px; display: inline-grid'><b>选择器</b></div>" +
                   "<div style='width:20%; margin-left:5px; display: inline-grid'><b>活动</b></div>" +
                   "<div style='width:60%; margin-left:5px; display: inline-grid'><b>Javascript 代码</b></div>")),
                addItem: function(container, i, javascriptHandler) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    
                    // Column 1 : Add an input field (type string) to the new row, that represents the selector for this event to operate on.
                    var selectorField = $('<input/>',{class:"node-input-javascript-selector",type:"text",placeholder:"元素选择器"}).css({"width":"17%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    selectorField.val(javascriptHandler.selector);
                    selectorField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(selectorField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            selectorField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                source: function(req, add){
                                    var list = [...node.nonAnimationIdSelectors,...node.nonAnimationClasses] || []
                                    add($.ui.autocomplete.filter(list , req.term));
                                }
                            });
                        }
                    });                     
                    
                    // Column 2 : Add an input field (type option) to the new row, that represents the action type 
                    var actionField = $('<select/>',{class:"node-input-javascript-action",type:"text",placeholder:"点击"}).css({"width":"20%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    for(var val in actionOptions) {
                        $('<option />', {value: val, text: actionOptions[val]}).appendTo(actionField);
                    }
                    // A js event handler can also be triggered when an input message arrives
                    $('<option />', {value: "msg", text: "输入消息"}).appendTo(actionField);
                    // When the "msg" option is selected, then the selector field has no meaning (so it should become disabled)
                    actionField.on('change', function() {
                        if( this.value == "msg") {
                            selectorField.val("");
                            selectorField.prop('disabled', true);
                        }
                        else {
                            selectorField.prop('disabled', false);
                        }
                    });
                    actionField.val(javascriptHandler.action || "click");

                    // Column 3 : Add an input field (type option) to the new row, that represents the javascript event handler code
                    var javascriptField = $('<textarea/>',{class:"node-input-javascript-sourceCode", type:"text"}).css({"width":"45%","margin-left":"5px","margin-right":"5px","min-height":"34px","resize":"vertical",}).appendTo(row);
                    javascriptField.val(javascriptHandler.sourceCode);
                    
                    // Column 4 : Add a button to expand the Javascript editor
                    var buttonField = $('<button title="Expand JS editor"><i class="fa fa-expand"></i></button>').css({"resize":"none","vertical-align":"top","width":"30px","height":"34px","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    // When the button is clicked, show an ACE editor (with the javascript code) in fullscreen
                    buttonField.click(function(e) {
                        var fullScrJsElement = $('#node-input-javascript-editor');
                        fullScrJsElement.show();
                        node.javascriptEditor = RED.editor.createEditor({
                            id: 'node-input-javascript-editor',
                            mode: 'ace/mode/javascript',
                            value: javascriptField.val()
                        });
                        node.javascriptEditor.setFontSize(14); 
                        
                        var fullScrRequest = fullScrJsElement[0].requestFullscreen || fullScrJsElement[0].mozRequestFullScreen || fullScrJsElement[0].webkitRequestFullscreen || fullScrJsElement[0].msRequestFullScreen;
                        if(fullScrRequest){
                            $('#node-input-javascript-editor').on('webkitfullscreenchange mozfullscreenchange msRequestFullscreen fullscreenchange', function(e) {
                                // When returning from fullscreen mode
                                if (!document.fullscreenElement) {
                                    // Store the javascript code from the ACE editor in this node
                                    javascriptField.val(node.javascriptEditor.getValue());
                                    
                                    node.javascriptEditor.destroy();
                                    fullScrJsElement[0].innerHTML = ''; // Remove all previous ACE editor DOM elements
                                    fullScrJsElement.hide();
                                }
                            });
                            
                             // Expand the javascript editor parent DIV element to fullscreen
                            fullScrRequest.call(fullScrJsElement[0]);
                        } 
                    });
                },
                removable: true
            });

            // Show all the clickable shapes (stored in this node) into the editableList
            if (this.javascriptHandlers) {
                this.javascriptHandlers.forEach(function (javascriptHandler, index) {
                    // CAUTION: The "targetId" now contains the CSS selector (instead of the element id).  
                    //          But we cannot rename it anymore in the stored json, since we don't want to have impact on existing flows!!!
                    //          This is only the case for clickable shapes, not for animations (since there is no CSS selector possible)...
                    javascriptHandlersList.editableList('addItem', {selector:javascriptHandler.selector, action:javascriptHandler.action, sourceCode:javascriptHandler.sourceCode});
                });
            }
            
            // Make sure the column name keeps being identical to the selected output message field
            $('#node-input-outputField').on('change', function() {
                var outputField = $('#node-input-outputField').val();
                $('#node-input-columnPayload').css("font-weight","Bold");
                $('#node-input-columnPayload').text("msg." + outputField);
            });
            $('#node-input-outputField').change();
            
            var bindingList = $("#node-input-binding-container").css('min-height','150px').css('min-width','450px').editableList({
                header: $("<div>").css({"margin-left":"6px"}).append($.parseHTML(
                    "<div style='width:28%; margin-left:5px; display: inline-grid'><b>绑定源</b></div>" +
                    "<div style='width:24%; margin-left:1px; display: inline-grid'><b>选择器</b></div>" +
                    "<div style='width:40%; margin-left:1px; display: inline-grid'><b>绑定目标</b></div>"
                )),
                addItem: function(container, i, binding) {
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);
                    //BINDING SOURCE
                    // Column 1 :  bind msg.xxxx 
                    var bindSourceField = $('<input/>',{class:"node-input-binding-source",type:"text",placeholder:"有效数据属性"})
                        .css({"width":"24%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    bindSourceField.val(binding.bindSource);  
               
                    //BINDING DESTINATION
                    // Column 2 : [textbox] Selector denoting what elements to add binding to (with autocomplete of .classes & #elementIDs)
                    var targetSelectorField = $('<input/>',{class:"node-input-binding-selector",type:"text",placeholder:"元素选择器"})
                        .css({"width":"28%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var targetSelectorFieldId = "node-input-binding-selector" + i
                    targetSelectorField.attr("id",targetSelectorFieldId);
                    targetSelectorField.val(binding.selector);
                    targetSelectorField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        if(targetSelectorField.data('ui-autocomplete') == undefined){ //only load if not already loaded
                            targetSelectorField.autocomplete({
                                classes: {
                                    "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                                },
                                source: function(req, add){
                                    var list = [...node.nonAnimationIdSelectors,...node.nonAnimationClasses] || []
                                    add($.ui.autocomplete.filter(list, req.term));
                                }
                            });
                        }
                    });                      

           
                    // Column 3 : [dropdown] Binding Type ["Text Content","Attribute Value"]
                    var bindingTypeField = $('<select/>',{class:"node-input-binding-type",type:"text",placeholder:"点击"})
                        .css({"width":"20%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    $('<option />', {value: "text", text: "文本"}).appendTo(bindingTypeField);
                    $('<option />', {value: "attr", text: "属性"}).appendTo(bindingTypeField);
                    $('<option />', {value: "style", text: "样式"}).appendTo(bindingTypeField);
                    bindingTypeField.val(binding.bindType || "text");
                    
                    // Column 4 : [textbox] Attribute to update (only used when bindingType == "attr") 
                    var attributeField = $('<input/>',{class:"node-input-binding-attribute",type:"text",placeholder:"属性"})
                        .css({"width":"20%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    var attributeFieldId = "node-input-binding-attribute" + i
                    attributeField.attr("id",attributeFieldId);
                    attributeField.val(binding.attribute);
                    attributeField.focusin(function() { // Only load autocomplete on selection (performance reasons)
                        // The content of the autocomplete list depends on the value of the binding type.  Since the binding type
                        // can have been changed meanwhile, we will reload the autocomplete list every time again.
                        attributeField.autocomplete({
                            classes: {
                                "ui-autocomplete": "ui-svg-ui-autocomplete", //add custom class for styling the dropdown
                            },
                            source: function(req, add){
                                // The autocomplete list content depends on the binding type
                                switch(bindingTypeField.val()) {
                                    case "attr":
                                        add($.ui.autocomplete.filter(node.attrList, req.term));
                                        break;
                                    case "style":
                                        add($.ui.autocomplete.filter(node.presentationAttrList, req.term));
                                        break;
                                }
                            }
                        });
                    });  
                    bindingTypeField.change(function () {
                        if (bindingTypeField.val() === "attr" || bindingTypeField.val() === "style") {
                            attributeField.show();
                        }
                        else {
                            attributeField.hide();
                        }
                    });
                    bindingTypeField.change();
                    //console.log("Created binding row for " +  binding.selector)
                },
                removable: true
            });

            // Add all the binding into the editableList
            if (this.bindings) {
                this.bindings.forEach(function (binding, index) {
                    //console.log("Adding binding row for " +  binding.selector)
                    bindingList.editableList('addItem', {selector:binding.selector, bindSource:binding.bindSource, bindType:binding.bindType, attribute:binding.attribute});
                });
            }
            
            node.initialised = true;
            
            function showDrawSVG(src,title,width,height){
                
                window.svgEditorFrame = $('<iframe id="drawsvg" frameborder="0" marginwidth="0" marginheight="0" allowfullscreen></iframe>');
                window.svgEditorDialogDiv = $("<div id='svg-dialog-div'></div>").append(window.svgEditorFrame).appendTo("body")
                
                // Open the Div (containing an iFrame) in a popup dialog
                window.svgEditorDialog = window.svgEditorDialogDiv.dialog({
                    autoOpen: false,
                    modal: true,
                    resizable: true,
                    width: "auto",
                    height: "auto",
                    minHeight: 440,
                    minWidth: 600,
                    title: title,
                    open: function( event, ui ) {
                        window.svgEditorDialog.closeConfirmed = false;
                        window.svgEditorFrame[0].src = src;
                        window.svgEditorFrame.attr({
                            width: "99%",// +width,
                            height:"99%",// +height,
                            src: src
                        });
                        initJsChannel();
                    },
                    close: function() {
                        window.svgEditorDialog.dialog('destroy');
                        window.svgEditorDialog.remove();  
                        window.svgEditorFrame.remove();
                        window.svgEditorFrame = null;
                        window.svgEditorDialog = null;
                    },
                    beforeClose: function(event, ui) { 
                        console.log("已单击SVG编辑器对话框关闭按钮");
                        if(window.svgEditorDialog.closeConfirmed){
                            return true;
                        }
                        var fail = function(error, message) { 
                            console.error(error,message); 
                            
                            // Simplify the timeout message
                            if (error === "timeout_error") {
                                message = "No response from the editor";
                            }
                            
                            messageBox.show(
                                "从编辑器获取SVG时出错.<br>错误消息...<br>" + message + "<br>按“确定”返回编辑器，或按“关闭”返回节点红色（更改可能会丢失）。",
                                "Error getting SVG!",
                                "fa-exclamation-triangle", 
                                {
                                    buttons:{
                                        "OK":function(){
                                            messageBox.close();
                                        },
                                        "Close":function(){
                                            window.svgEditorDialog.closeConfirmed = true;
                                            messageBox.close();
                                            closeJsChannel();
                                            window.svgEditorDialog.dialog("close"); 
                                        }
                                    }
                                }
                            );
                        }
                        var success = function(v) {
                            var svgStr = v.stringSVG;
                            var dirty = v.modified;
                            if(dirty===false){
                                window.svgEditorDialog.closeConfirmed = true;
                                messageBox.close();
                                closeJsChannel();
                                window.svgEditorDialog.dialog("close"); 
                            } else {
                                var options = {
                                buttons : {
                                    "Yes":function(){
                                        sendSVGtoSource(svgStr);
                                        window.svgEditorDialog.closeConfirmed = true;
                                        messageBox.close();
                                        closeJsChannel();
                                        window.svgEditorDialog.dialog("close");
                                    },
                                    "No": function(){
                                        window.svgEditorDialog.closeConfirmed = true;
                                        messageBox.close();
                                        closeJsChannel();
                                        window.svgEditorDialog.dialog("close"); 
                                    },
                                    "Cancel": function(){
                                        window.svgEditorDialog.closeConfirmed = false;
                                        messageBox.close();
                                    }
                                }
                            }
                            messageBox.show("保存变更?", "确定", "fa-question", options )
                            }
                        }
                        getSVGData(success, fail);
                        return false;
                     }
                });
                
                // Let's customize the popup dialog, by setting a custom title and a 'Save' menu button (to save intermediate) and a full screen button
                window.svgEditorDialogDiv.parent().find(".ui-dialog-titlebar").append('<button id="btnSave" style="right: 26px" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-dialog-titlebar-close" title="Save"><span class="ui-button-icon ui-icon ui-icon-disk"></span></button>');
                window.svgEditorDialogDiv.parent().find(".ui-dialog-titlebar").append('<button id="btnMaximise" style="right: 48px" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-dialog-titlebar-close" title="Fullscreen"><span class="ui-button-icon ui-icon ui-icon-arrow-2-ne-sw"></span></button>');
                
                window.svgEditorDialog.dialog("option", "width", width);
                window.svgEditorDialog.dialog("option", "height", height);
                window.svgEditorDialog.dialog("open");  

                $("#btnSave").click(function(){
                    saveSVG();
                });
                
                var drawsvgFullScrElement = $('#drawsvg')[0];
                var fsr = drawsvgFullScrElement.requestFullscreen || drawsvgFullScrElement.mozRequestFullScreen || drawsvgFullScrElement.webkitRequestFullscreen || drawsvgFullScrElement.msRequestFullScreen;
                if(fsr){
                    $("#btnMaximise").click(function(e){
                        e.preventDefault()
                        if (node.fullscreen === false) {
                            if (fsr) {
                                fsr.call(drawsvgFullScrElement);//triggers oneditresize()
                            }
                        } else {
                            document.exitFullscreen();//triggers oneditresize()
                        }
                    })
                }                 
            }
            function saveSVG(onSuccess, onError){
                console.log("取消保存SVG")
                var fail = function(error, message) { 
                    console.error(error,message); 
                    if(onError){
                        onError(error,message);
                    } else {
                        messageBox.show(message,"获取SVG时出错！","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                    }
                }
                var success = function(v) {
                    var svgStr = v.stringSVG;
                    var dirty = v.modified;
                    sendSVGtoSource(svgStr);
                    if(onSuccess){
                        onSuccess(v);
                    } else {
                        messageBox.show("更改已发送到SVG源代码","保存","fa-thumbs-o-up", {buttons:{"OK":function(){messageBox.close();}}} );
                    }                            
                }
                getSVGData(success, fail);
            }

            function getSVGData(onSuccess, onFail) {
                console.log("调用getSVG方法...")
                
                // Try to get an SVG object from the SVG editor.  However when the editor doesn't respond (e.g. because we
                // used an incorrect url) then we should give an error after a timeout of 2 seconds
                window.drawSvgCommChannel.call({
                    method: "getSVGObject",
                    params: {},
                    timeout: 2000,
                    error: onFail,
                    success: onSuccess
                });                
            }

            function closeJsChannel(){
                try {
                    if(window.drawSvgCommChannel){
                        window.drawSvgCommChannel.unbind("onDrawSVGReady");
                        window.drawSvgCommChannel.unbind("onSaveSVG");
                        window.drawSvgCommChannel.destroy();
                    }    
                } catch (error) {    
                }
                window.drawSvgCommChannel = null;
            }
            function initJsChannel(){
                closeJsChannel();
                // Create once a drawsvg channel (to communicate with the editor in the iFrame)
                window.drawSvgCommChannel = Channel.build({
                    debugOutput: true,
                    window: document.getElementById("drawsvg").contentWindow,
                    origin: "*",
                    scope: "drawsvg"
                });
                
                // bind drawsvg ready callback 
                window.drawSvgCommChannel.bind("onDrawSVGReady", function (trans,params) {
                    // now you can communicate with drawsvg
                    console.log("收到绘制svg就绪通知");
                    // setting document menu
                    // call 'setDocumentMenu' method 
                    // with params {enableSamples, disableTasks}
                    window.drawSvgCommChannel.call({
                        method: "setDocumentMenu",
                        params: {
                            // enable samples sub-menu
                            'enableSamples' : true,
                            // disable save (handled manually)
                            'disableTasks' : 'save'
                        },
                        // jsChannel callbacks
                        error: function(error, message) { 
                            console.error(error);
                            messageBox.show(message,"设置编辑器时出错！","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                            },
                        success: function(v) {
                            console.log("设置文档菜单已完成");
                            window.drawSvgCommChannel.editorSVGLoaded = true;
                            sendSVGtoEditor()
                        }
                    });                   
                    return "connected";
                });

                // save svg service
                // bind save callback
                window.drawSvgCommChannel.bind("onSaveSVG", function (trans,params) {
                    console.log("关于保存SVG名称SVG="+params['nameSVG']+" stringSVG="+params['stringSVG']);
                    sendSVGtoSource(params['stringSVG'])
                    return "save done";
                });
            }//end initJsChannel()

            function sendSVGtoSource(svgStr) {
                // Convert the SVG string (that we received from DrawSvg) into a temporary DOM tree, which allows us to 
                // search easily through the SVG.  See https://discourse.nodered.org/t/temporary-dom-elements-somewhere-cached/15520
                var svgElement = new DOMParser().parseFromString(svgStr, "image/svg+xml");

                // When the element contains a data-xlink-href, this means it is referring to a local image.  The xlink:href attribute will
                // contain the base64 encoded string of that local image, and the data-xlink-href contains the url (file://...) to that
                // local image.  We will replace the base64 string by the local image url.
                svgElement.querySelectorAll("[data-xlink-href]").forEach(function (element) {
                    var xlinkHref = element.getAttribute("data-xlink-href");
                    element.removeAttribute("data-xlink-href");
                    element.setAttribute("xlink:href", xlinkHref);
                })       

                // Convert the manipulated DOM tree back into an SVG string
                svgStr = new XMLSerializer().serializeToString(svgElement);                        
                
                if(node.autoFormatAfterEdit){
                    svgStr = beautifySVG(svgStr);
                }
                window.node_ace_svg_editor.setValue(svgStr);
            }

            function sendSVGtoEditor(){
                // Since the external DrawSvg cloud editor cannot access local server image files, we load the image bytes and convert it to a base64 encoded
                // data URL (which is stored into the SVG string).  The original (relative) local image path is stored in a data-xlink-href attribute 
                // (on the same image element), so it can be restored when returning back from DrawSvg.
                // For example: The image element has an attribute xlink:href="/someLocalImage.jpg" (linux) or xlink:href="\someLocalImage.jpg" (windows)
                var svgString = window.node_ace_svg_editor ? window.node_ace_svg_editor.getValue() : "";
                svgString = svgString.replace(/(xlink:href="[\\\/]{1})([^"]*)(")/g, function(match, $1, $2, $3, offset, input_string) {
                    var newUrl = "";
                    // This is the local file URL, without the (back)slash in front
                    var relativeFilePath = $2;
                    
                    // Since dots are not allowed in an url, we will replace them by underscores
                    var nodeId = node.id.replace(".", "_");

                    $.ajax({
                        type: "GET",
                        url: "ui_svg_graphics/image/" + nodeId + "/" + relativeFilePath, 
                        async: false, // Synchronous call
                        success: function(response, status, xhr){ 
                            var contentType = xhr.getResponseHeader("content-type") || "";
                        
                            // Return data url of base64 encoded image string.
                            // And store the original file name in a custom 'data' attribute
                            newUrl = 'xlink:href="data:' + contentType + ';base64,' + response + '" data-xlink-href="/' + relativeFilePath + '"';
                        },
                        error: function() {
                            // Leave the local file path untouched, since we cannot load the specified image
                            newUrl = $1 + $2 + $3;
                        }
                    });

                    return newUrl;
                })
                    
                window.drawSvgCommChannel.call({
                    method: "loadStringSVG",
                    params: {
                        'stringSVG' : svgString,
                        //'backgroundImageURL' : '/background.jpg',
                        'nameSVG' : 'node-red',// svg name
                        // The name of the service which to be called 
                        // when user clicks on the save button of drawsvg
                        'saveService' :  'onSaveSVG',
                        // don't show save dialog
                        'showSaveDialog' : false,
                        // Change the dimensions of the document to the full window (100%)
                        'fullWindow' : true,
                        // svg loading callbacks
                        'onLoad' : function() {console.log("got svg1 onLoad notification");},
                        'onError': function(err) {
                            console.error(err);
                            messageBox.show(err,"加载SVG时出错！","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                        }
                    },
                    // jsChannel callbacks
                    error: function(error, message) { 
                        messageBox.show(message,"与SVG编辑器通信时出错!","fa-exclamation-triangle", {buttons:{"OK":function(){messageBox.close();}}});
                    },
                    success: function(v) {}
                });
            }//end sendSVGtoEditor()

            $(".node-display-svg-popup").on("click", function (e) {
                console.log("node-display-svg-popup clicked")
                e.preventDefault();
                var winwid = $(window).width();
                var winhei = $(window).height();
                var src = $("#node-input-editorUrl").val();
                var title = $(this).attr("data-title");
                var width = winwid - ((winwid/100)*5);//window width less 5%
                var height = winhei - ((winhei/100)*5);//window height less 5%

                // When the "#jsChannel:" postfix is not available in the URL, then the onDrawSVGReady will never be executed!
                // We will send our key in the url, so Joseph sees in his logs how many people are drawing via Node-RED.
                if(!src.endsWith("#jsChannel:?key=487a80da-f75a-4ab7-975f-055ff24ac400")) {
                    src += "#jsChannel:?key=487a80da-f75a-4ab7-975f-055ff24ac400";
                }
                showDrawSVG(src,title,width,height);
            });
            $(".node-format-svg-source").on("click", function (e) {
                try {
                    var svgIn = node.svgEditor.getValue();
                    var svgOut = beautifySVG(svgIn);
                    window.node_ace_svg_editor.setValue(svgOut);
                } catch (error) {
                    console.error(error);
                }       
            });
            function beautifySVG(svg, options){
                var opts = {
                    "indent_size": "2",
                    "indent_char": " ",
                    "max_preserve_newlines": "-1",
                    "preserve_newlines": false,
                    "keep_array_indentation": false,
                    "break_chained_methods": true,
                    "indent_scripts": "normal",
                    "brace_style": "expand",
                    "space_before_conditional": true,
                    "unescape_strings": false,
                    "jslint_happy": false,
                    "end_with_newline": false,
                    "wrap_line_length": "0",
                    "indent_inner_html": false,
                    "comma_first": false,
                    "e4x": false,
                    "indent_empty_lines": false
                };
                $.extend(opts, options);//merge options into opts (in case of duplicates, options takes precidence)
                return html_beautify(svg,opts);
            }
            
            $(".node-format-svg-css").on("click", function (e) {
                try {
                    var cssIn = node.cssEditor.getValue();
                    var cssOut = beautifyCSS(cssIn);
                    window.node_ace_css_editor.setValue(cssOut);
                } catch (error) {
                    console.error(error);
                }       
            });
            function beautifyCSS(css, options){
                var opts = {
                    'indent_size': 2,
                    'indent_char': '\t',
                    'selector_separator': ' ',
                    'end_with_newline': false,
                    'newline_between_rules': true,
                    'space_around_selector_separator': true
                };
                $.extend(opts, options);//merge options into opts (in case of duplicates, options takes precidence)
                return css_beautify(css,opts);
            }
            
            $(".node-reset-svg-css").on("click", function (e) {
                var currentCssString = node.cssEditor.getValue();
                
                if(currentCssString && currentCssString.trim() != "") {
                    if(!confirm("Do you really want to reset the CSS styles?")) {
                        return;
                    }
                }
                
                node.cssEditor.setValue(DEFAULT_CSS_SVG_NODE);
            });
            
            $("#node-input-restoreUrl").on("click", function (e) {
                $("#node-input-editorUrl").val("//drawsvg.org/drawsvg.html");
            });
            setTimeout(function() {
                $("#node-input-name").css({"width":"70%"});    
            }, 50);//workaround for odd over sizing of name field       

            // Migrate old nodes which don't have pan/zoom functionality yet
            $('#node-input-panning').val(this.panning || "disabled");
            $('#node-input-zooming').val(this.zooming || "disabled");
            
            $("#node-input-panning").on("change", function(){
                var panAndZoomEnabled = $(this).val() !== "disabled" && $("#node-input-zooming").val() !== "disabled";
                
                var panOnlyWhenZoomedElement = $("#node-input-panOnlyWhenZoomed")[0];
                
                // The checkbox panOnlyWhenZoomed is only enabled when both panning and zooming are enabled
                if (panAndZoomEnabled) {
                    panOnlyWhenZoomedElement.nextElementSibling.style.color= "black"; // on label
                    panOnlyWhenZoomedElement.disabled = false;
                }
                else {
                    panOnlyWhenZoomedElement.nextElementSibling.style.color= "darkgrey"; // on label
                    panOnlyWhenZoomedElement.checked = false;
                    panOnlyWhenZoomedElement.disabled = true;
                }
            });
            $("#node-input-panning").change();

            $("#node-input-zooming").on("change", function(){
                var panAndZoomEnabled = $(this).val() !== "disabled" && $("#node-input-zooming").val() !== "disabled";
                
                var panOnlyWhenZoomedElement = $("#node-input-panOnlyWhenZoomed")[0];
                
                // The checkbox panOnlyWhenZoomed is only enabled when both panning and zooming are enabled
                if (panAndZoomEnabled) {
                    panOnlyWhenZoomedElement.nextElementSibling.style.color= "black";
                    panOnlyWhenZoomedElement.disabled = false;
                }
                else {
                    panOnlyWhenZoomedElement.nextElementSibling.style.color= "darkgrey"; // on label
                    panOnlyWhenZoomedElement.checked = false;
                    panOnlyWhenZoomedElement.disabled = true;
                }
                
                var zoomEnabled = $(this).val() !== "disabled";
     
                var mouseWheelZoomEnabledElement = $("#node-input-mouseWheelZoomEnabled")[0];
                var doubleClickZoomEnabledElement = $("#node-input-doubleClickZoomEnabled")[0];
                
                // The checkboxes mouseWheelZoomEnabled and doubleClickZoomEnabled are only enabled when zooming are enabled
                if (panAndZoomEnabled) {
                    mouseWheelZoomEnabledElement.nextElementSibling.style.color= "black"; // on label
                    doubleClickZoomEnabledElement.nextElementSibling.style.color= "black"; // on label
                    mouseWheelZoomEnabledElement.disabled = false;
                    doubleClickZoomEnabledElement.disabled = false;
                }
                else {
                    mouseWheelZoomEnabledElement.nextElementSibling.style.color= "darkgrey"; // on label
                    doubleClickZoomEnabledElement.nextElementSibling.style.color= "darkgrey"; // on label
                    mouseWheelZoomEnabledElement.disabled = true;
                    doubleClickZoomEnabledElement.disabled = true;
                    mouseWheelZoomEnabledElement.checked = false;
                    doubleClickZoomEnabledElement.checked = false;
                }
            });
            $("#node-input-zooming").change();
            
            $("#node-input-doubleClickZoomEnabled").on("change", function(){
                var dblClickZoomPercentage = $("#node-input-dblClickZoomPercentage")[0];
                if ($(this)[0].checked) {
                    dblClickZoomPercentage.disabled = false;
                }
                else {
                    dblClickZoomPercentage.disabled = true;
                }
            });
            $("#node-input-doubleClickZoomEnabled").change();
        },
        oneditsave: function() {
            var node = this;

            var annot = this.svgEditor.getSession().getAnnotations();
            this.noerr = 0;
            $("#node-input-noerr").val(0);
            for (var k=0; k < annot.length; k++) {
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    this.noerr = annot.length;
                }
            }
            
            var svgString = this.svgEditor.getValue();
            $("#node-input-svgString").val(svgString);
            this.svgEditor.destroy();
            delete this.svgEditor;
            delete window.node_ace_svg_editor;
            
            // Copy all the animations from the editableList to this node
            node.smilAnimations = [];
            var smilAnimationsList = $("#node-input-animations-container").editableList('items');
            smilAnimationsList.each(function(i) {
                var amin = getAnimationObjectFromFormRow(this);
                node.smilAnimations.push(amin);
            });
            
            // Copy all the clickable shapes (i.e. events) from the editableList to this node
            node.clickableShapes = [];
            var clickableShapesList = $("#node-input-clickable-container").editableList('items');
            clickableShapesList.each(function(i) {
                var clickableShape = $(this);
                var selector = clickableShape.find(".node-input-clickable-selector").val();
                var action = clickableShape.find(".node-input-clickable-action").val();
                var payload  = clickableShape.find(".node-input-clickable-payload").val();
                var payloadType  = clickableShape.find(".node-input-clickable-payloadType").val();
                var topic    = clickableShape.find(".node-input-clickable-topic").val();
                
                // CAUTION: The "targetId" now contains the CSS selector (instead of the element id).  
                //          But we cannot rename it anymore in the stored json, since we don't want to have impact on existing flows!!!
                //          This is only the case for clickable shapes, not for animations (since there is no CSS selector possible)...
                node.clickableShapes.push({targetId:selector, action:action, payload:payload, payloadType:payloadType, topic:topic});
            });
            
            // Copy all the javascript event handlers from the editableList to this node
            node.javascriptHandlers = [];
            var javascriptHandlersList = $("#node-input-javascript-container").editableList('items');
            javascriptHandlersList.each(function(i) {
                var javascriptHandler = $(this);
                var selector = javascriptHandler.find(".node-input-javascript-selector").val();
                var action = javascriptHandler.find(".node-input-javascript-action").val();
                var sourceCode = javascriptHandler.find(".node-input-javascript-sourceCode").val();              

                node.javascriptHandlers.push({selector:selector, action:action, sourceCode:sourceCode});
            });
            
            // Copy all the bindings from the editableList to this node
            node.bindings = [];
            var bindingList = $("#node-input-binding-container").editableList('items');
            bindingList.each(function(i) {
                var amin = getBindingFromFormRow(this);
                node.bindings.push(amin);
            });
            window.node_ace_svg_editor = null;
            
            annot = this.cssEditor.getSession().getAnnotations();
            $("#node-input-noerr").val(0);
            for (var k=0; k < annot.length; k++) {
                if (annot[k].type === "error") {
                    $("#node-input-noerr").val(annot.length);
                    this.noerr += annot.length;
                }
            }
            
            var cssString = this.cssEditor.getValue();
            $("#node-input-cssString").val(cssString);
            this.cssEditor.destroy();
            delete this.cssEditor;
            delete window.node_ace_css_editor;
        },
        oneditcancel: function() {
            this.svgEditor.destroy();
            delete this.svgEditor;
            delete window.node_ace_svg_editor;
            delete window.node_ace_css_editor;
            delete this.cssEditor;
        },
        oneditresize: function(size) {
            updateEditorHeight(this);
        }
    });
</script>


<script type="text/html"  data-template-name="ui_svg_graphics">
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> 组</span></label>
        <input type="text" id="node-input-group">
    </div>    
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> 尺寸</span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="名称">
    </div>
    <div class="form-row">
        <!-- Tabsheets -->
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-svg-tabs"></ul>
    </div>
    <div id="node-svg-tabs-content" style="min-height: 150px">
        <!-- Content of all tabsheets -->
        <div id="node-svg-tab-editor" class="node-svg-tab-content" style="position: relative; text-align: center; margin-top: 30px;">           
            <button id="node-display-svg-popup" 
                class="svgButton node-display-svg-popup" 
                data-href="//drawsvg.org/drawsvg.html#jsChannel:" 
                data-title="SVG Editor">
                <div class="svgButtonIcon">  
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60" version="1.1"><!-- Generator: Sketch 51.3 (57544) - http://www.bohemiancoding.com/sketch --><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="012---Edit-Text" fill="#ffffff" fill-rule="nonzero"><path d="M11.92,16 L18.08,16 C18.5816184,16.0001393 19.0501055,15.7495298 19.3283997,15.332189 C19.6066939,14.9148482 19.6579559,14.3860216 19.465,13.923 L16.384,6.523 C16.1510259,5.96417691 15.6049421,5.60019992 14.9995,5.60019992 C14.3940579,5.60019992 13.8479741,5.96417691 13.615,6.523 L10.535,13.923 C10.3420441,14.3860216 10.3933061,14.9148482 10.6716003,15.332189 C10.9498945,15.7495298 11.4183816,16.0001393 11.92,16 Z M15,8.4 L17.331,14 L12.669,14 L15,8.4 Z" id="Shape"/><path d="M2,29 L8,29 C9.1045695,29 10,28.1045695 10,27 L10,26 C9.99715878,25.0134931 9.51156415,24.0908633 8.7,23.53 L10.167,20 L19.833,20 L21.588,24.217 C21.2052017,24.7325545 20.9989841,25.3578707 21,26 L21,27 C21,28.1045695 21.8954305,29 23,29 L29,29 C30.1045695,29 31,28.1045695 31,27 L31,26 C30.9978857,24.4411833 29.8041514,23.1427964 28.251,23.01 L19.18,1.231 C18.8694142,0.485331324 18.1407656,-0.000302895298 17.333,4.23429917e-17 L13.667,4.23429917e-17 C12.8592344,-0.000302895298 12.1305858,0.485331324 11.82,1.231 L2.749,23.01 C1.19584863,23.1427964 0.00211433151,24.4411833 0,26 L0,27 C2.09738034e-15,28.1045695 0.8954305,29 2,29 Z M2,26 C2,25.4477153 2.44771525,25 3,25 L3.42,25 C3.8238222,24.9998655 4.18793229,24.7568624 4.343,24.384 L13.667,2 L17.333,2 L26.657,24.384 C26.8120677,24.7568624 27.1761778,24.9998655 27.58,25 L28,25 C28.5522847,25 29,25.4477153 29,26 L29,27 L23,27 L23,26 C23.0040027,25.6919001 23.1455981,25.4017395 23.386,25.209 C23.7335967,24.9312445 23.8558685,24.4572375 23.686,24.046 L21.686,19.231 C21.3745779,18.4833108 20.6429478,17.9972683 19.833,18 L10.167,18 C9.35935132,17.998312 8.63044906,18.4839836 8.321,19.23 L6.477,23.655 C6.36218989,23.9308511 6.37674397,24.243589 6.51667728,24.5075849 C6.65661059,24.7715808 6.90726124,24.9591738 7.2,25.019 C7.6639235,25.1176028 7.99674471,25.5257248 8,26 L8,27 L2,27 L2,26 Z" id="Shape"/><path d="M42.112,51.28 L48.292,50.044 C48.7763649,49.9476703 49.2211865,49.7095967 49.57,49.36 L52.546,46.384 C52.8074121,46.1224696 53.007553,45.806206 53.132,45.458 L59.83,26.7 C60.1163189,25.8892813 59.9117422,24.9861881 59.304,24.378 C58.9974834,24.0764266 58.6077918,23.8733969 58.185,23.795 C58.0609259,23.1593718 57.6659496,22.6093993 57.1032643,22.2887705 C56.540579,21.9681417 55.8660838,21.908709 55.256,22.126 L54,22.578 L54,11.57 C54,7.243 54,-4.46691295e-16 44.75,-4.46691295e-16 C41.8428326,-0.0184684772 38.9763984,0.683795856 36.407,2.044 C35.644589,2.48300306 35.2585826,3.36866658 35.456,4.226 L36.067,6.861 C36.2048502,7.44824596 36.60225,7.94094808 37.147,8.2 C37.700402,8.46245662 38.3430249,8.45951388 38.894,8.192 C40.5309628,7.41085175 42.3212122,7.00368187 44.135,7 C44.9108183,6.95485539 45.6886512,7.04244614 46.435,7.259 C46.868,7.431 47.135,7.689 47.117,8.459 C47.117,8.721 47.104,9.43 47.084,9.999 C43.129,10.023 39.384,10.416 36.522,13.18 C33.8430608,15.7163103 32.7839886,19.5248154 33.769,23.08 C34.4752821,25.3657456 36.1535984,27.2237116 38.356,28.158 L36.499,28.822 C36.1505681,28.9465849 35.8340068,29.1466981 35.572,29.408 L32.6,32.39 C32.2502828,32.7383242 32.0121712,33.1828688 31.916,33.667 L30.68,39.848 C30.6604756,39.944649 30.6128111,40.0333678 30.543,40.103 L29.087,41.559 C28.3120731,41.44701 27.5296358,41.7063405 26.975,42.259 L22.732,46.5 C21.7560452,47.4762496 21.7560452,49.0587504 22.732,50.035 L31.925,59.228 C32.9012496,60.2039548 34.4837504,60.2039548 35.46,59.228 L39.7,54.985 C40.2526877,54.4299699 40.5119963,53.6472283 40.4,52.872 L41.855,51.417 C41.9251744,51.3468432 42.0146368,51.2991531 42.112,51.28 Z M35.688,22.511 C34.9121205,19.6709117 35.7689319,16.63456 37.915,14.619 C40.461,12.162 44,11.975 48,12 C49.12,12 49.12,11.108 49.12,8.48 C49.2462734,7.13167591 48.44905,5.86728451 47.178,5.4 C46.2008824,5.07528136 45.1708835,4.93953192 44.143,5 C42.0210586,5.00286873 39.9267357,5.4812587 38.014,6.4 L37.378,3.788 C39.6499936,2.59241307 42.1827243,1.97812626 44.75,2 C51.48,2 52,5.966 52,11.57 L52,23.292 L41.7,26.971 C38.9498397,26.9188443 36.5355672,25.1278171 35.688,22.511 Z M34.046,57.811 C33.8507501,58.006191 33.5342499,58.006191 33.339,57.811 L24.146,48.619 C23.950809,48.4237501 23.950809,48.1072499 24.146,47.912 L25.914,46.144 L35.814,56.044 L34.046,57.811 Z M38.289,53.569 L37.228,54.629 L27.328,44.729 L28.389,43.668 C28.5842499,43.472809 28.9007501,43.472809 29.096,43.668 L38.289,52.86 C38.3839648,52.9539219 38.437404,53.0819349 38.437404,53.2155 C38.437404,53.3490651 38.3839648,53.4770781 38.289,53.571 L38.289,53.569 Z M40.442,50 L39.349,51.1 L30.864,42.61 L31.956,41.518 C32.3060603,41.1693879 32.5445057,40.7245218 32.641,40.24 L33.876,34.06 C33.8956185,33.9628781 33.9436507,33.8737748 34.014,33.804 L36.989,30.828 C37.0415571,30.7756902 37.1050912,30.7357252 37.175,30.711 L42.187,28.921 L42.217,28.91 L53.379,24.923 L53.394,24.923 L55.929,24.023 C56.0270919,23.9893025 56.1355093,24.0270242 56.1914999,24.1143316 C56.2474905,24.201639 56.2365456,24.3159083 56.165,24.391 L47.027,33.528 C45.2921917,32.5044983 43.0669597,32.9305994 41.8329806,34.5225829 C40.5990016,36.1145663 40.7412587,38.3757569 42.1650296,39.8005347 C43.5888005,41.2253126 45.84989,41.3691682 47.4427454,40.1363149 C49.0356008,38.9034617 49.463275,36.6785314 48.441,34.943 L57.579,25.8 C57.6148455,25.7480819 57.6739097,25.7170871 57.737,25.7170871 C57.8000903,25.7170871 57.8591545,25.7480819 57.895,25.8 C57.9552035,25.8602422 57.9754329,25.9497182 57.947,26.03 L51.247,44.785 C51.2219361,44.8544504 51.1820056,44.9175884 51.13,44.97 L48.154,47.946 C48.0840966,48.0159836 47.9950061,48.0636609 47.898,48.083 L41.718,49.319 C41.2346347,49.4146911 40.790548,49.6516998 40.442,50 Z M46.42,38.368 C45.6286285,39.1233037 44.3833715,39.1233037 43.592,38.368 C43.0198788,37.7960515 42.8486566,36.9357685 43.1581832,36.1883456 C43.4677098,35.4409226 44.1970205,34.9535729 45.006,34.9535729 C45.8149795,34.9535729 46.5442902,35.4409226 46.8538168,36.1883456 C47.1633434,36.9357685 46.9921212,37.7960515 46.42,38.368 Z" id="Shape"/><path d="M48.021,15 C44.864,14.938 41.384,15.12 39.475,16.99 C38.5782384,17.8810069 38.0936816,19.1056273 38.138,20.369 C38.0600373,21.6119005 38.5167928,22.8289002 39.3932666,23.7135885 C40.2697404,24.5982768 41.4824264,25.066365 42.726,25 C45.4244899,25.0565985 47.8511361,23.3652997 48.732,20.814 C48.9003341,20.3224135 48.9907597,19.8075269 49,19.288 L49,16 C49.00012,15.4558134 48.5650666,15.0114279 48.021,15 Z M47,19.288 C46.9910731,19.5902336 46.9361079,19.8893385 46.837,20.175 C46.2402391,21.9206983 44.5696005,23.068729 42.726,23 C42.0143431,23.0634839 41.311628,22.8051131 40.8105918,22.2957521 C40.3095556,21.7863912 40.0627986,21.0795143 40.138,20.369 C40.0984418,19.6442692 40.3659812,18.9363968 40.875,18.419 C42.094,17.224 44.762,17 47,16.99 L47,19.288 Z" id="Shape"/><path d="M3,30 C2.44771525,30 2,30.4477153 2,31 L2,39 C2,39.5522847 2.44771525,40 3,40 C3.55228475,40 4,39.5522847 4,39 L4,36 L27,36 L27,39 C27,39.5522847 27.4477153,40 28,40 C28.5522847,40 29,39.5522847 29,39 L29,31 C29,30.4477153 28.5522847,30 28,30 C27.4477153,30 27,30.4477153 27,31 L27,34 L4,34 L4,31 C4,30.4477153 3.55228475,30 3,30 Z" id="Shape"/></g></g></svg>              
                </div>
                <div class="svgButtonText">打开SVG编辑器</div>
            </button>
            <div id="node-display-svg-popup-no-url" style="position: absolute; top: 50%; left: 50%; margin-right: -50%; transform: translate(-50%, -50%); background-color: rgb(235, 235, 235);" 
                class="form-tips">
                <i class="fa fa-globe"></i> 编辑器URL未设置！更新URL <a id="gotoSettingsButton" href="javascript:void(0)" class="red-ui-tab-label" title="Settings">设置</a> tab.
            </div>
        </div>        
        <div id="node-svg-tab-source" class="node-svg-tab-content">
            <!-- Ace SVG source editor -->
            <div class="form-row" style="margin-bottom:0px;">
                <input type="hidden" id="node-input-svgString" style="width: 100%; height: 100%; ">
            </div>
            <div class="form-row node-source-editor-row form-row-auto-height">
                <div id="node-input-svg-source" class="node-source-editor" style="width: 100%; height: 100%; min-height:150px;"></div>
                <button id="node-expand-svg-source" class="node-expand-svg-source editor-button editor-button-small" style="margin-top: 4px;" title="Expand source">
                    <i class="fa fa-expand"></i>
                </button>
                <button id="node-format-svg-source" class="node-format-svg-source editor-button editor-button-small" style="margin-top: 4px;" title="Format SVG">
                    <i class="fa fa-code"></i>    
                </button>
            </div>
        </div>
        <div id="node-svg-tab-animations" class="node-svg-tab-content">
            <div class="form-row form-row-auto-height">
                <!-- Table with SMIL animations -->
                <ol id="node-input-animations-container"></ol>
            </div>
        </div>
        <div id="node-svg-tab-clickable" class="node-svg-tab-content">
            <div class="form-row" style="padding-left: 2px;">
                <label for="node-input-outputField"><i class="fa fa-envelope"></i> 输出 到</label>
                <div class="red-ui-typedInput-container" style="width: 70%; margin-right: 5px; margin-left: 3px;">    
                    <button class="red-ui-typedInput-type-select"> 
                        <span class="red-ui-typedInput-type-label">msg.</span>
                    </button>
                    <div class="red-ui-typedInput-input-wrap" style="left: 46px; right: 2px;">
                        <input type="text" id="node-input-outputField" placeholder="payload" style="width: 100%; margin-right: 0px; margin-left: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px;" autocomplete="disable" dir="" class="red-ui-typedInput-input">
                    </div>
                </div>
            </div>
            <div class="form-row form-row-auto-height">
                <!-- Table with clickable shapes -->
                <ol id="node-input-clickable-container"></ol>
            </div>
        </div>
        <div id="node-svg-tab-javascript" class="node-svg-tab-content">
            <div id="node-input-javascript-editor" class="form-row" style="margin: 20px;"></div>
            <div class="form-row form-row-auto-height">
                <!-- Table with javascript event handlers -->
                <ol id="node-input-javascript-container"></ol>
            </div>
        </div>
        <div id="node-svg-tab-binding" class="node-svg-tab-content">
            <div class="form-row form-row-auto-height">
                <!-- Table with clickable shapes -->
                <ol id="node-input-binding-container"></ol>
            </div>   
        </div>   
        <div id="node-svg-tab-settings" class="node-svg-tab-content">
            <div class="form-row">
                <input type="checkbox" id="node-input-showCoordinates" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-showCoordinates" style="width:70%;"> 显示鼠标坐标(作为工具提示)</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-autoFormatAfterEdit" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-autoFormatAfterEdit" style="width:70%;"> 在SVG编辑器中保存编辑后自动格式化SVG源代码</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-showBrowserErrors" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-showBrowserErrors" style="width:70%;">在服务器上显示浏览器错误</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-showBrowserEvents" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-showBrowserEvents" style="width:70%;"> 在服务器上显示浏览器事件</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-enableJsDebugging" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-enableJsDebugging" style="width:70%;"> 启用JS事件调试</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-sendMsgWhenLoaded" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-sendMsgWhenLoaded" style="width:70%;"> 重新加载客户端时发送输出消息</label>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-input-noClickWhenDblClick" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-noClickWhenDblClick" style="width:70%;"> 在双击事件的情况下不发送点击事件</label>
            </div>
            <div class="form-row" id="div-editorUrl">
                <label for="node-input-editorUrl"><i class="fa fa-globe"></i>编辑 URL</label>
                <input type="text" id="node-input-editorUrl">
                <button id="node-input-restoreUrl" class="editor-button" title="还原默认URL"><i class="fa fa-undo"></i></button>
            </div>
            <div class="form-row">
                <label for="node-input-directory"><i class="fa fa-folder"></i> 目录</label>
                <input type="text" id="node-input-directory" placeholder="选择目录">
            </div>
            </br>
            <div class="form-row">
                <label for="node-input-panning"><i class="fa fa-arrows"></i> 平移</label>
                <select id="node-input-panning">
                    <option value="disabled">禁用</option>
                    <option value="both">平移X和Y</option>
                    <option value="x">仅平移X</option>
                    <option value="y">仅平移XY</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-zooming"><i class="fa fa-search-plus"></i> 缩放</label>
                <select id="node-input-zooming">
                    <option value="disabled">禁用</option>
                    <option value="enabled">启用</option>
                </select>
            </div>
            <div class="form-row">
                <label>&nbsp;</label>
                <input type="checkbox" id="node-input-panOnlyWhenZoomed" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-panOnlyWhenZoomed" style="width:70%;"> 仅在缩放时平移</label>
            </div>      
            <div class="form-row">
                <label>&nbsp;</label>
                <input type="checkbox" id="node-input-mouseWheelZoomEnabled" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-mouseWheelZoomEnabled" style="width:70%;"> 启用鼠标滚轮缩放</label>
            </div>
            <div class="form-row">
                <label>&nbsp;</label>
                <input type="checkbox" id="node-input-doubleClickZoomEnabled" style="display: inline-block; width: auto; vertical-align: super;">
                <span style="vertical-align: super;"> 通过以下方式启用双击缩放</span>
                <input type="number" id="node-input-dblClickZoomPercentage" style="width:55px;vertical-align:super;margin-left:5px" min="100">
                <span style="vertical-align:super;super：margin-left:5px"> %</span>
            </div>
        </div>
        <div id="node-svg-tab-css" class="node-svg-tab-content">
            <!-- Ace CSS source editor -->
            <div class="form-row" style="margin-bottom:0px;">
                <input type="hidden" id="node-input-cssString" style="width: 100%; height: 100%; ">
            </div>
            <div class="form-row node-css-editor-row form-row-auto-height">
                <div id="node-input-svg-css" class="node-css-editor" style="width: 100%; height: 100%; min-height:150px;"></div>
                <button id="node-expand-svg-css" class="node-expand-svg-css editor-button editor-button-small" style="margin-top: 4px;" title="Expand CSS">
                    <i class="fa fa-expand"></i>
                </button>
                <button id="node-format-svg-css" class="node-format-svg-css editor-button editor-button-small" style="margin-top: 4px;" title="Format CSS">
                    <i class="fa fa-code"></i>    
                </button>
                <button id="node-reset-svg-css" class="node-reset-svg-css editor-button editor-button-small" style="margin-top: 4px;" title="Reset CSS">
                    <i class="fa fa-undo"></i>    
                </button>
            </div>
        </div>
    </div>
</script>
<script type="text/html" data-help-name="ui_svg_graphics">
    <p>ICCControl节点，用于在仪表板内显示矢量图形（SVG）绘图。</p>
    <p><b>请参阅我们的自述页面<a target=“_blank”href=“https://github.com/bartbutenaers/node-red-contrib-ui-svg“>Github</a>了解更多信息</b></p>
    <h3>通用属性...</h3>
    <dl class="message-properties">
        <h4>Group</h4>
        <div style="padding-left: 15px">
            您希望SVG在仪表板上显示的位置。
        </div>
        <h4>尺寸</h4>
        <div style="padding-left: 15px">
            面板上部件的大小
        </div>    
        <h4>名称</h4>
        <div style="padding-left: 15px">
            此节点的名称
        </div>
        <h3><b>Tabs...</b></h3>
        <h4>编辑器</h4>
        <div style="padding-left: 15px">
            单击按钮在DrawSvg图形编辑器中打开SVG图形。
            <p><i>注意：如果设置选项卡上的<code>Editor URL</code>为空，SVG编辑器将不可用！</i></p>
            <p><strong>!!! DrawSvg是免费软件。DrawSvg按“原样”提供，不作任何明示或暗示的保证 !!!</strong></p>
        </div>
        <h4>SVG</h4>
        <div style="padding-left: 15px">
            要显示的原始SVG。SVG源代码可以直接在这里编辑。
            <p>按钮...</p>
            <ul>
                <li><span class="editor-button editor-button-small" style="margin-top: 4px;" title="扩展来源">
                        <i class="fa fa-expand"></i>    
                    </span> 将SVG源代码编辑器扩展到全屏。
                </li>
                <li><span class="editor-button editor-button-small" style="margin-top: 4px;" title="SVG格式">
                        <i class="fa fa-code"></i>    
                    </span> 将重新格式化SVG源代码。
                </li>
            </ul>
        </div>
        <h4>动画</h4>
        <div style="padding-left: 15px">
            可定制的动画列表。每个动画都以一个元素为目标，您可以在其中指定要设置动画的属性。
            <p>笔记...</p>
            <ul>
                <li>The <code>动画 id</code> 指定应用于此动画的id。</li>
                <li>The <code>目标元素 id</code> 指定将动画应用于哪个元素。</li>
                <li><code>类</code> 类字段允许您通过类名来处理动画。例如，您可以使用<code>选择器</code>“.spinters”向所有动画的“trigger_animation”发送<code>msg</code> </ul>
                <li>The <code>属性名称</code> 指定要设置动画的属性</li>
                <li>The <code>开始</code> 到 <code>结束</code> 的值是指定动画的开始值和结束值</li>
                <li><code>动画结束</code>
                    <ul>
                        <li>冻结新值：将动画结束值保持在动画结束处</li>
                        <li>恢复原始值：在动画结束时恢复原始值</li>
                    </ul>
                </li>
                <li><code>触发</code>
                    <ul>
                        <li>输入消息：不要启动动画，而是等待<code>msg</code>（请参阅下面的触发动画命令） </li>
                        <li>时间延迟：在指定时间后开始动画</li>
                        <li>自定义：使用标准的<code>begin</code>选项，例如<code>2s；myRect.click；myAnim.end-400ms</code><i target=“blank”href=“https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/begin“>请参见此处</i>。</li>
                    </ul>
                </li>
            </ul>
            <p><i><strong>注意</strong>: 这里不可能使用CSS选择器，而只能使用一个SVG形状（通过目标元素Id字段）</i> 只能（在输入消息中）通过CSS选择器一次选择多个动画（如下所述）。</p>
        </div>        
        <h4>事件</h4>
        <div style="padding-left: 15px">
            可定制的事件列表。每个事件都针对一个元素，您可以在其中指定要在指定操作后发送的操作（例如单击、鼠标悬停、聚焦等）和有效数据/主题。
            此外，<code>输出到</code>允许您指定将有效数据发送到<code>msg</code>的哪个部分。
        </div>
        <div style="padding-left: 15px">
            <i>请注意（在“选择器”字段中），可以通过<a target=“_blank”href=指定单个SVG形状或多个SVG形状的idhttps://www.w3schools.com/cssref/css_selectors.asp“>CSS选择器</a>！</i>在后一种情况下，所有与CSS选择器匹配的SVG形状都将响应指定的事件。
        </div>
        <h4>绑定</h4>
        <div style="padding-left: 15px">
            一个可定制的绑定列表，允许用户轻松指定文本和属性绑定。
            例如，可以发送一个带有嵌套对象/属性的<code>msg</code>对象，以设置此列表中指定的元素文本和属性的动画。
            <ul>
                <li><b>源</b> -您希望将<code>msg</code>中的哪些属性用作此绑定中的值</li>
                <li><b>选择器</b> - 这个绑定应该处理哪些元素（例如<code>.indicators</code>会影响SVG中class=“indicators”的所有元素）。任何有效的<a target=“_blank”href=“https://www.w3schools.com/cssref/css_selectors.asp“>CSS选择器</a>可用于选择一个或多个SVG形状。</li>
                <li><b>目标</b> -
                    <ul>
                        <li>If <code>文本</code> 如果选中，元素的内部文本内容将使用绑定源的值进行更新。</li>
                        <li>If <code>属性</code> 如果选中，则下一个输入中指定的属性将使用绑定源的值进行更新。</li>
                        <li>If <code>样式</code> 如果选中，则下一个输入中指定的样式属性将使用绑定源的值进行更新。</li>
                    </ul>    
                </ul>
            </ul>
            <p>注意:<code>主题</code>必须设置为<code>数据绑定</code></p>
        </div>
        <h4>JS</h4>
        <div style="padding-left: 15px">
            一个可定制的Javascript事件处理程序列表。每个事件都针对一个元素，您可以在其中指定要执行的操作（例如单击、鼠标悬停、聚焦等）和一个Javascript代码片段。
        </div>
        <div style="padding-left: 15px">
            <i>请注意（在“选择器”字段中），可以通过<a target=“_blank”href=指定单个SVG形状或多个SVG形状的idhttps://www.w3schools.com/cssref/css_selectors.asp“>CSS选择器</a>！</i>在后一种情况下，所有与CSS选择器匹配的SVG形状都将响应指定的事件。
        </div>
        <h4>CSS</h4>
        <div style="padding-left: 15px">
            CSS样式，其范围将仅限于此SVG源！
        </div>
    </dl>
    <h3>输出</h3>
    <dl class="message-properties">
        <dt><i>有效数据（见“输出到”）</i> <span class="property-type">number|string|boolean|object|buffer</span></dt>
        <dd>msg。[Output to]将包含“payload”中配置的任何内容</dd>
        <dd>例如，如果“输出到”设置为<b>data.value</b>，则<code>msg.data.value</code>将包含<i>有效数据</i></dd>
        <dd>msg对象还添加了其他属性。检查调试输出（使用show complete消息）</dd>
    </dl>

    <h3>输入-命令<i>（高级用法）</i></h3>
    <dl class="message-properties">
        <dt><i>有效数据</i> <span class="property-type">string|object|Array</span></dt>
        <dd>可以通过<code>msg</code>动态触发SVG图形上的所有类型的操作</dd>
        <dd>关于输入消息的一般准则：
            <ul>
                <li><code>命令</code>指定要执行的操作。</li>
                <li><code>elementId</code>或<code>选择器</code>指定需要对哪些元素执行操作。<code>elementId</code>用于指定单个元素id。而<code>选择器</code><a target=“_blank”href=“https://www.w3schools.com/cssref/css_selectors.asp“>CSS选择器</a>，可用于一次选择多个SVG元素。请注意，选择器也可用于通过标签（<i>”#some_element_id“</i>）选择单个元素id。</li>
                <li><code>有效数据</code>可以包含单个命令对象，也可以包含多个命令对象的数组。</li>
                <li>可以在消息<code>主题</code>中指定命令和选择器，并且只指定有效载荷中的新值:
                    <pre style="white-space: pre">
 var msg = {
    "topic": "update_text|#myRect > .faultMessage",
    "payload": "hello"
 }
 return msg;</pre>
                </li>
            </ul>        
        </dd>
        <dd>
            <p><b>触发动画（通过“开始”或“停止”动作）:</b><br>
                <pre style="white-space: pre">"payload": [
 {
    "command": "trigger_animation",
    "selector": "#myAnimation",
    "action": "start"
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li><code>动作</code>可以是<i>“开始”</i>或<i>（停止）</i>。</li>
                        <li>这只适用于在“动画”选项卡中指定的动画，触发器为<i>“输入消息”</i>！</li>
                    </ul>
                </p>
            </p>
            
            <p><b>更新或设置属性值:</b><br>
                <pre style="white-space: pre">"payload": [
 {
    "command": "update_attribute",
    "selector": "#myRect > .statusBar",
    "attributeName": "fill",
    "attributeValue": "red"
 },
 {
    "command": "set_attribute",
    "selector": "#myRect > .faultMessage",
    "attributeName": "display",
    "attributeValue": "inline"
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li>将<code>attributeName</code>与<code>ttributeValue</code>结合使用，以更新指定属性的（字符串或数字）值。</li>
                        <li>可以通过为attributeValue发送空字符串来删除属性。</li>
                        <li><code>set_attribute</code>可以用来代替<code>update_attribute</code>，当一个新的属性还不存在时，应该创建它。</li>
                        <li><code>update_attribute</code>只会更改现有的属性，但当属性尚不存在时，不会执行任何操作。</li>
                    </ul>
                </p>
            </p>
            
            <p><b>设置样式属性值:</b><br>
                <pre style="white-space: pre">payload": [
 {
    "command": "update_style",
    "selector": "#myRect > .statusBar",
    "attributeName": "fill",
    "attributeValue": "red"
 },
 {
    "command": "update_style",
    "selector": "#myRect > .faultMessage",
    "style": {"display": "inline", "fill": "blue", "transform": "rotate(5deg)"} 
 }
]</pre>
                                
                <p><i>注意:</i><br>
                    <ul>
                        <li>将<code>attributeName</code>与<code>ttributeValue</code>结合使用，以更新指定样式属性的（字符串或数字）值。</li>
                        <li>使用<code>style</code>更新整个样式对象，即使用单个命令更新所有样式属性值。</li>
                        <li>通过为<code>属性值</code>或<code>样式值</code>发送空字符串，可以删除样式属性。</li>
                        <li>命令<code>set_style</code>可以用来代替执行完全相同功能的<code>update_style</code>。</li>
                    </ul>
                </p>                
            </p>

            <p><b>设置或获取文本内容</b><br>
                <pre style="white-space: pre">"payload": [
 {
    "command": "update_text",
    "selector": "#myRect > .faultMessage",
    "text": "Hello from a command message"
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li>除了指定<code>text</code>字段外，还可以使用别名<code>html</code>或<code>text Content-</code>。</li>
                        <li>使用命令<i>“get_text”</i>字段获取当前文本内容。</li>
                        <li><code>文本</code>可以包含HTML或SVG标记。</li>
                    </ul>
                </p> 
            </p>
            
            <p><b>添加或删除事件</b><br>
                <pre style="white-space: pre">"payload": [
 {
    "command": "add_event",
    "event": "click",
    "selector": "#circle_2", 
    "payload": "circle 2 has been clicked",
    "topic": "CIRCLE_CLICKED"
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li>事件处理程序将被添加到所选元素中，以处理指定的<code>事件</code>。</li>
                        <li>事件发生后，将立即发送一条输出消息，其中包含指定的<code>有效载荷</code>和<code>主题</code>。</li>
                        <li>当使用命令<i>“remove_event”</i>时，只需要<code>事件</code>和<code>选择器</code>。</li>
                    </ul>
                </p> 
            </p>
            
            <p><b>添加或删除Javascript事件</b><br>
                <pre style="white-space: pre">"payload": [
 {
    "command": "add_js_event",
    "event": "click",
    "selector": "#circle_2", 
    "script": "alert('点击客户端处理的事件 ...')"
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li>事件处理程序将被添加到所选元素中，以处理指定的<code>事件</code>。</li>
                        <li>一旦事件发生，指定的javascript<code>脚本</code>将在客户端（即面板内）执行。</li>
                        <li>当使用命令<i>“remove_js_event”</i>时，只需要<code>事件</code>和<code>选择器</code>。</li>
                    </ul>
                </p> 
            </p>
            
            <p><b>添加或删除元素</b><br>
                <pre style="white-space: pre">"payload": [
 {
   "command": "add_element", 
   "elementType": "circle",
   "elementId": "extra_circle", 
   "elementAttributes": [
      "cx": "100",
      "cy": "50",
      "r": "30"
   ],
   "elementStyleAttributes": [
      "fill": "red",
      "stroke": "black"
   ],
   "textContent": "my content"
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li>当指定了<code>parentElementId</code>时，新元素将作为该父元素的子元素添加。如果未指定，新元素将直接添加到根SVG元素下方。</li>
                        <li>当指定了<code>parentSelector</code>时，将添加一个新元素作为每个父元素的子元素。在这种情况下，不允许指定<code>elementId</code>，因为添加了多个元素（不允许具有相同的元素id）。</li>
                        <li>当已有一个具有相同<code>elementId</code>的现有元素（位于同一父元素）时，现有元素将被新元素替换。</li>
                        <li>当使用命令<i>“remove_element”</i>时，只需要<code>elementId</code>。或者，如果需要使用单个命令删除多个元素，则可以使用<code>选择器</code></li>
                    </ul>
                </p> 
            </p>
            
            <p><b>放大或缩小</b><br>
                <pre style="white-space: pre">"payload": [
 {
    "command": "zoom_in"
 }
]</pre>
                <pre style="white-space: pre">"payload": [
 {
    "command": "zoom_out"
 }
]</pre>
                <pre style="white-space: pre">"payload": [
 {
   "command": "zoom_by_percentage",
   "percentage": 130
 }
]</pre>
                <pre style="white-space: pre">"payload": [
 {
   "command": "zoom_by_percentage",
   "percentage": 130,
   "x": 300,
   "y": 400
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li><i>“zoom_in”</i><i>”zoom_out”</i>命令使用固定的缩放百分比。</li>
                        <li><i>“zoom_by_apercent”</i>命令可用于指定自定义<code>百分比</code>。</li>
                        <li><i>“zoom_by_apercent”</i>命令可以有可选的<code>x</code>和<code>y</code>坐标，以放大特定位置。</li>
                    </ul>
                </p> 
            </p>
            
            <p><b>平移</b><br>
                <pre style="white-space: pre">"payload": [
 {
   "command": "pan_to_point",
   "x": 300,
   "y": 400
 }
]</pre>
                <pre style="white-space: pre">"payload": [
 {
   "command": "pan_to_direction",
   "x": 300,
   "y": 400
 }
]</pre>
                <p><i>注意:</i><br>
                    <ul>
                        <li><i>“pan_to_point”</i>命令用于绝对平移（到指定位置）。</li>
                        <li><i>“pan_to_direction”</i>命令用于相对平移（在指定方向上）。</li>
                    </ul>
                </p> 
            </p>
        </dd>
        <br>

        <h3>输入-数据绑定<i>（高级用法）</i></h3>
        <dl class="message-properties">
            <dt><i>topic</i> <span class="property-type">string</span></dt>
            <dd>当<code>主题</code>设置为<code>时，数据绑定</code>文本内容和属性可以通过<code>有效载荷</code>>的属性进行更新</dd>
            <dt><i>payload</i><span class=“property type”>string|objects|array</span></dt>
            <dd>通过设置相应的<code>数据绑定</code>属性并向节点发送输入消息，可以更新文本内容和元素属性</dd>
            <dd>
                <p>
                    例如 SVG...<br>
                        <pre style="white-space: pre">&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:svg=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;
    &lt;circle data-bind-attributes=&quot;fill,r&quot; data-bind-values=&quot;payload.circleColour,payload.size&quot; cx=&quot;350&quot; cy=&quot;120&quot; r=&quot;25&quot; stroke-width=&quot;0&quot; fill=&quot;lime&quot;/&gt;
    &lt;text data-bind-text=&quot;payload.pressure&quot; x=&quot;342&quot; y=&quot;128&quot; stroke=&quot;black&quot; font-size=&quot;16&quot; text-anchor=&quot;left&quot;&gt; --- &lt;/text&gt; 
    fill=&quot;#FF0000&quot;/&gt;
&lt;/svg&gt;</pre>
                    例如 payload...<br>
                        <pre style="white-space: pre">[
    {
        "topic": "databind",
        "payload": {
            "circleColour": "red",
            "size": "40",
            "pressure": 44
        }
    }
]</pre>
                </p>
            </dd>
        </dl>            
    </dl>
</script>
